<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ollama èŠå¤©</title>
    <!-- CSS -->
    <style>
body {
    margin: 0;
/*    font-family: Arial, sans-serif;*/
    background-color: #222222;
    display: flex;

}

/* Sidebar for conversation history */
.sidebar {
    width: 260px;
    height: 100vh;
    background-color: #151515;
    color: white;
    display: flex;
    flex-direction: column;
/*    border-right: 1px solid #444;*/
}

.sidebar-header {
    padding: 16px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
/*    border-bottom: 1px solid #444;*/
}

.conversations-list-title {
    font-size: 14px;
    font-weight: bold;
    color: #aaa;
    margin-top: 10px;
    padding: 6px 16px;
}


.new-chat-btn {
    background-color: #151515;
    color: white;
    border: 0px solid #444;
    border-radius: 10px;
    padding: 10px 15px;
    width: 100%;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.new-chat-btn:hover {
    background-color: #ffffff24;
}

.conversations-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.conversation-item {
    font-size: 14px;
    padding: 10px;
    margin-bottom: 5px;
    border-radius: 10px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-item:hover {
    background-color: #222;
}

.conversation-item.active {
    background-color: #262626;
}

/* Main chat area */
.main-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

/* Top bar with model selector */
.top-bar {
    padding: 10px 20px;
/*    border-bottom: 1px solid #444;
    background-color: #262626;*/
    display: flex;
    align-items: center;


    background: linear-gradient(180deg, #222222 55%, #22222200 100%);
    padding-bottom: 30px;
    margin-bottom: -30px;
    z-index: 1;
}

.model-selector {
/*    background-color: #262626;
    border: 1px solid #444;*/

    background-color: #313131;
    border: 0px;
    color: white;
    padding: 8px;
    border-radius: 5px;
    outline: none;
    width: auto;
    font-size: 18px;
    font-weight: bold;

}

#system-prompt{
        background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 100%;
    min-height: 80px;
    resize: vertical;
    margin-top: 6px;
    font-size: 14px;
        border-radius: 5px;
    padding: 5px;
    font-size: 12px;
    width: calc(100% - 10px);
}
.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
    position: relative;
}


.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 3px;
}


.conversations-list::-webkit-scrollbar {
    width: 6px;
}

.conversations-list::-webkit-scrollbar-thumb {
    background-color: #353535;
    border-radius: 3px;
}

#message-input::-webkit-scrollbar {
    width: 6px;
}
#message-input::-webkit-scrollbar-thumb {
    background-color: #666;
    border-radius: 3px;
}

/* Welcome message */
.welcome-container {
    display: none;
    position: relative;
    height: 100%;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #e0e0e0;
    text-align: center;
    padding: 20px;
}

.welcome-title {
    font-size: 2em;
    margin-bottom: 20px;
    font-weight: bold;
}

.welcome-subtitle {
    font-size: 1.2em;
    margin-bottom: 30px;
    color: #c0c0c0;
}

.welcome-examples {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    max-width: 800px;
}

.example-item {
    background-color: #3a3a3a;
    padding: 15px;
    border-radius: 8px;
    max-width: 300px;
    cursor: pointer;
}

.example-item:hover {
    background-color: #4a4a4a;
}

.example-title {
    font-weight: bold;
    margin-bottom: 8px;
}

.chat {
    max-width: 80%;
    margin: 15px auto;
    display: flex;
    flex-direction: column;
}

.chat.user {
    align-items: flex-end;
}

.chat.assistant {
    align-items: flex-start;
}

.chat .role {
    font-weight: bold;
    margin-bottom: 5px;
    color: #e0e0e0;
    font-size: 0.9em;
}

.chat .message {
    padding: 12px 16px;
    border-radius: 25px;
    box-sizing: border-box;
    line-height: 1.5;
}

.chat.user .message {
    background: #333;
    color: white;
}

.chat.assistant .message {
/*    background: #3a3a3a;*/
    color: white;
}

p {
        margin: 8px 0px;
}

/* Input area */
.input-container {
    padding: 15px 20px;
/*    border-top: 1px solid #444;
    background-color: #262626;*/
        background: linear-gradient(0deg, #222222 85%, #22222200 100%);
    padding-top: 30px;
    margin-top: -30px;
    z-index: 1;
}

.message-form {
    display: flex;
    flex-direction: column;
    max-width: 800px;
    margin: 0 auto;
/*    border: 1px solid #444;*/
    border-radius: 20px;
        padding: 5px;
    background-color: #333;
}

.input-wrapper {
    position: relative;
    margin-bottom: 10px;
/*    border: 1px solid #444;*/
    border-radius: 10px;
    background-color: #333;
}

#message-input {
    width: 100%;
    min-height: 60px;
    padding: 15px;
    font-size: 16px;
    box-sizing: border-box;
    background-color: transparent;
    border: none;
    outline: none;
    color: white;
    resize: none;
    border-radius: 10px;
}

.input-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

.pill-button {
    border-radius: 20px;
    padding: 6px 10px;
    background-color: #444;
    color: white;
    border: none;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.pill-button:hover {
    background-color: #555;
}

.pill-button.active {
    background-color: #2c536c;
}
 /* æ–°å¢çš„é«˜çº§åˆ«æ ·å¼ */
.pill-button.active-high {     
    background-color: #6c2c36;
    font-weight: bold;
 }
.send-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #238636;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
        margin-bottom: 8px;
}

.send-button:hover {
    background-color: #2baa43;
}

.send-button:disabled {
    background-color: #555;
    cursor: not-allowed;
}

/* Think container styling */
.think-container {
    margin: 0px 0;
/*    border: 1px solid #555;*/
    border-radius: 5px;
    overflow: hidden;
}



.think-toggle {
/*    background-color: #3a3a3a;*/
/*    padding: 8px 12px;*/
    cursor: pointer;
    display: flex;
    align-items: center;
}

.think-icon {
    margin-right: 8px;
}

.think-toggle span{
    color: #aaa;
    font-size: 14px;
    font-weight: bold;
}


.think-content, .think-content2 {
    margin: 10px 0px;
    font-size: 13px;
        border-left: 2px solid #666;
/*    background-color: #2a2a2a;*/
}


/*.think-content2::before {
content: "";
    position: absolute;
    width: 2px;
    height: calc(100% - 130px);
    margin-top: 5px;
    margin-left: -8px;
    background-color: #666;
}*/


.think-content pre, .think-content2 pre {
    margin: 0;
    white-space: pre-wrap;
        font-size: 13px;
        font-weight: 500;
    border-radius: 0px;
    background-color: transparent;
    word-wrap: break-word;
        color: #bbb;
    font-family: 'Courier New', Courier, monospace;
}

/* Parameter panel */
#param-window {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #262626;
    border: 1px solid #444;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    z-index: 100;
    display: none;
}

.param-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 99;
    display: none;
}

.param-header {
    padding: 12px 16px;
/*    background: #2a2a2a;*/
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    font-weight: bold;
}

.param-close {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

.param-content {
    padding: 16px;
    max-height: 70vh;
    overflow-y: auto;
}

.param-group {
    margin-bottom: 16px;
}

.param-group-title {
    font-size: 14px;
    color: #e0e0e0;
    margin-bottom: 10px;
    font-weight: bold;
}

.param-item {
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.param-item label {
    color: #e0e0e0;
    font-size: 0.85em;
    flex-shrink: 0;
}

.param-item input, .param-item textarea {
    background: #333;
    border: 1px solid #444;
    border-radius: 4px;
    color: white;
    padding: 6px 8px;
}

.param-item input {
    width: 100px;
}



.param-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.param-button {
    flex: 1;
    padding: 8px;
    background: #444;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 14px;
}

.param-button:hover {
    background: #555;
}

.utility-buttons {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.utility-button {
    flex: 1;
    padding: 10px;
    background: #333;
    border: 1px solid #444;
    border-radius: 4px;
    color: white;
    cursor: pointer;
}

.utility-button:hover {
    background: #3a3a3a;
}

@media (max-width: 768px) {
    .sidebar {
        position: absolute;
        left: -260px;
        transition: left 0.3s ease;
        z-index: 100;
    }
    
    .sidebar.open {
        left: 0;
    }
    
    .main-container {
        width: 100%;
    }
    
    .mobile-sidebar-toggle {
        display: block;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 101;
    }
}
.conversation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.delete-conversation-btn {
    visibility: hidden;
    cursor: pointer;
    color: #666;
    padding: 2px;
    border-radius: 3px;
}

.conversation-item:hover .delete-conversation-btn {
    visibility: visible;
}

.delete-conversation-btn:hover {
    color: #ff3333;
    background-color: rgba(255,0,0,0.1);
}


pre {
    background: #161616;
    border-radius: 5px;
    padding: 10px;
    color: #d7d7d7;
}


.custom-dropdown {
    position: relative;
    cursor: pointer;
    user-select: none;
    font-size: 18px;
    font-weight: bold;
}

.dropdown-selected {
    padding: 8px 12px;
    color: #aaa; /* ç™½è‰²æ–‡å­— */
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;

}


.dropdown-selected::after {
    content: '';
    position: absolute;
        right: -5px;
    width: 12px;
    height: 12px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2.5' stroke='%238e8ea0' class='size-3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}
.dropdown-menu {
    position: absolute;
    font-size: 14px;
/*    top: calc(100% + 5px);*/
    padding: 10px;
    left: 0;
    right: 0;
    background-color: #333; /* æ·±è‰²èƒŒæ™¯ */
    border-radius: 15px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 100;
    display: none; /* é»˜è®¤éšè— */
/*    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);*/
}

.dropdown-menu.show {
    display: block;
        min-width: 200px;
}

.dropdown-item {
    font-weight: 100;
    padding: 10px 12px;
    color: #fff; /* ç™½è‰²æ–‡å­— */
    transition: background-color 0.2s;
    border-radius: 10px;
    margin: 5px;
}

.dropdown-item:hover {
    background-color: #444; /* é€‰ä¸­æ—¶çš„æ·±è‰² */
    border-radius: 10px;
}

.dropdown-item.selected {
/*    background-color: #555; /* é€‰ä¸­æ—¶çš„æ·±è‰² */*/
    border-radius: 10px;
}




#loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #111; /* æ·±ç°è‰²èƒŒæ™¯ */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}



    .tifa-text {
      font-size: 3rem;
      font-weight: bold;
      color: #222;
      position: relative;
      background: linear-gradient(
        -90deg,
        #353535 0%,
        #353535 50%,
        #888 50%,
        #353535 65%
      );
      background-size: 300% auto;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 6s linear infinite;
    }
    
    @keyframes shine {
      100% {
        background-position: -100% center;
      }
      0% {
        background-position: 200% center;
      }
    }

    </style>
</head>


<body>
    <!-- Sidebar for conversation history -->
    <div id="loading-screen">
        <div class="tifa-text">Ollama</div>
    </div>
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn">

                æ–°å»ºèŠå¤©
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        <div class="conversations-list-title">å¯¹è¯å†å²</div>
        <div class="conversations-list" id="conversations-list">
            <!-- Conversation items will be added here dynamically -->
        </div>
    </div>
    
    <!-- Main chat area -->
    <div class="main-container">
        <!-- Top bar with model selector -->
<div class="top-bar">
    <div class="custom-dropdown" id="model-dropdown">
        <div class="dropdown-selected">é€‰æ‹©æ¨¡å‹...</div>
        <div class="dropdown-menu">
            <!-- è¿™é‡Œçš„é€‰é¡¹ä¼šç”±JSåŠ¨æ€å¡«å…… -->
        </div>
    </div>
</div>
                    <div class="welcome-container" id="welcome-container">
                <div class="welcome-title">æ¬¢è¿ä½¿ç”¨ Ollama èŠå¤©</div>
                <div class="welcome-subtitle">ä¸€ä¸ªå¼ºå¤§çš„æœ¬åœ°AIèŠå¤©å·¥å…·</div>
                <div class="welcome-examples">
                    <div class="example-item" data-example="å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—">
                        <div class="example-title">ğŸ’« åˆ›æ„å†™ä½œ</div>
                        <div>å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—</div>
                    </div>
                    <div class="example-item" data-example="è§£é‡Šé‡å­åŠ›å­¦çš„åŸºæœ¬åŸç†ï¼Œç”¨ç®€å•çš„è¯­è¨€">
                        <div class="example-title">ğŸ“š è§£é‡Šæ¦‚å¿µ</div>
                        <div>è§£é‡Šé‡å­åŠ›å­¦çš„åŸºæœ¬åŸç†ï¼Œç”¨ç®€å•çš„è¯­è¨€</div>
                    </div>
                    <div class="example-item" data-example="å¦‚ä½•åˆ¶ä½œä¸€ä¸ªä¼ ç»Ÿçš„æ„å¤§åˆ©ææ‹‰ç±³è‹ï¼Ÿ">
                        <div class="example-title">ğŸ³ é£Ÿè°±æŒ‡å¯¼</div>
                        <div>å¦‚ä½•åˆ¶ä½œä¸€ä¸ªä¼ ç»Ÿçš„æ„å¤§åˆ©ææ‹‰ç±³è‹ï¼Ÿ</div>
                    </div>
                    <div class="example-item" data-example="å¸®æˆ‘åˆ†æä»¥ä¸‹Pythonä»£ç çš„æ•ˆç‡é—®é¢˜:\ndef fibonacci(n):\n    if n <= 1:\n        return n\n    return fibonacci(n-1) + fibonacci(n-2)">
                        <div class="example-title">ğŸ’» ä»£ç åˆ†æ</div>
                        <div>å¸®æˆ‘åˆ†æPythonä»£ç çš„æ•ˆç‡é—®é¢˜</div>
                    </div>
                </div>
            </div>
        <div class="chat-container" id="chat-container">
            <!-- Welcome message (visible when chat is empty) -->

            <!-- Chat messages will be added here dynamically -->
        </div>
        
        <!-- Input area -->
        <div class="input-container">
            <div class="message-form">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="å‘é€æ¶ˆæ¯..."></textarea>
                </div>
                
                <div class="input-buttons">
                    <div class="action-buttons">
                        <button id="deep-thinking-toggle" class="pill-button">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
                            </svg>
                            æ·±åº¦æ€è€ƒ
                        </button>
                        
                        <button id="param-toggle-button" class="pill-button">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15.5C14.21 15.5 16 13.71 16 11.5C16 9.29 14.21 7.5 12 7.5C9.79 7.5 8 9.29 8 11.5C8 13.71 9.79 15.5 12 15.5ZM19.43 12.97C19.47 12.65 19.5 12.33 19.5 12C19.5 11.67 19.47 11.34 19.43 11L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.04 4.95 18.95L7.44 17.95C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.67 16.04 18.34 16.56 17.95L19.05 18.95C19.27 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z" fill="currentColor"/>
                            </svg>
                            è®¾ç½®
                        </button>
                    </div>
                    
                    <button id="submit" class="send-button" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Backdrop for modal -->
    <div class="param-backdrop" id="param-backdrop"></div>
    
    <!-- Advanced parameters panel -->
    <div id="param-window">
        <div class="param-header">
            <span>âš™ï¸ é«˜çº§è®¾ç½®</span>
            <button class="param-close" id="param-close">Ã—</button>
        </div>
        <div class="param-content">
            <div class="param-group">
                <div class="param-group-title">ç³»ç»ŸæŒ‡ä»¤</div>
                <textarea id="system-prompt" placeholder="è¾“å…¥ç³»ç»ŸæŒ‡ä»¤...">æ‚¨ç°åœ¨æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”æ¨¡å‹ï¼Œå‡†å¤‡æ¥å—ç”¨æˆ·çš„è§’è‰²è®¾å®šã€‚å°šæœªåŠ è½½ä»»ä½•è§’è‰²ã€‚</textarea>
            </div>
            
            <div class="param-group">
                <div class="param-group-title">APIè®¾ç½®</div>
                <div class="param-item">
                    <label>APIåœ°å€:</label>
                    <input type="text" id="api-base-url" placeholder="http://127.0.0.1:11434" style="width: 200px;">
                </div>
            </div>
            
            <div class="param-group">
                <div class="param-group-title">ç”Ÿæˆå‚æ•°</div>
                <div class="param-item">
                    <label>æ¸©åº¦:</label>
                    <input type="number" id="temperature" step="0.1" min="0" max="2" placeholder="0.6">
                </div>
                <div class="param-item">
                    <label>é‡å¤æƒ©ç½š:</label>
                    <input type="number" id="repeat_penalty" step="0.01" min="1" max="3" placeholder="1.06">
                </div>
                <div class="param-item">
                    <label>Top P:</label>
                    <input type="number" id="top_p" step="0.1" min="0" max="1" placeholder="0.6">
                </div>
                <div class="param-item">
                    <label>æœ€å¤§ä»¤ç‰Œæ•°:</label>
                    <input type="number" id="max_tokens" min="100" max="8000" placeholder="1000">
                </div>
            </div>
            
            <div class="param-actions">
                <button id="save-params" class="param-button">ä¿å­˜è®¾ç½®</button>
            </div>
            
            <div class="utility-buttons">
                <button id="rollback" class="utility-button">æ’¤é”€æœ€åä¸€æ¡</button>
                <button id="clean" class="utility-button">æ¸…ç©ºèŠå¤©</button>
                <button id="export-chat" class="utility-button">å¯¼å‡ºèŠå¤©</button>
            </div>
        </div>
    </div>


    <script src="./utils/marked.min.js"></script>
    <script>
window.addEventListener('load', function() {
    var loadingScreen = document.getElementById('loading-screen');
    loadingScreen.style.transition = 'opacity 0.5s';
    loadingScreen.style.opacity = '0';

    setTimeout(function() {
        loadingScreen.style.display = 'none';
    }, 500); // ç­‰å¾…0.5ç§’åéšè—åŠ è½½åŠ¨ç”»
});


document.addEventListener('DOMContentLoaded', () => {
    // é»˜è®¤è®¾ç½®
    let basePoint = "http://127.0.0.1:11434";
    let chatModel = "";
    const defaultParams = {
        temperature: 0.6,
        repeat_penalty: 1.06,
        top_p: 0.6,
        max_tokens: 1000
    };
    let params = {...defaultParams};
    let chatHistory = [];
    let replyIng = false;
    let controller = null;
    let isDeepThinkingEnabled = false;
    let conversations = [];
    let activeConversationId = null;
    let deepThinkingLevel = 0; // 0: å…³é—­, 1: ä½, 2: é«˜
    // DOM å…ƒç´ 
    const chatContainer = document.getElementById('chat-container');
    const welcomeContainer = document.getElementById('welcome-container');
    const submitButton = document.getElementById('submit');
    const messageInput = document.getElementById('message-input');
    const modelDropdown = document.getElementById("model-dropdown");
const dropdownSelected = modelDropdown.querySelector(".dropdown-selected");
const dropdownMenu = modelDropdown.querySelector(".dropdown-menu");
    const cleanButton = document.getElementById('clean');
    const deepThinkingToggle = document.getElementById('deep-thinking-toggle');
    const paramToggleButton = document.getElementById('param-toggle-button');
    const paramWindow = document.getElementById('param-window');
    const paramBackdrop = document.getElementById('param-backdrop');
    const paramClose = document.getElementById('param-close');
    const conversationsList = document.getElementById('conversations-list');
    const newChatBtn = document.querySelector('.new-chat-btn');
    const apiBaseUrlInput = document.getElementById('api-base-url');
    const exampleItems = document.querySelectorAll('.example-item');

    // åˆå§‹åŒ–åº”ç”¨
    initApp();

    function initApp() {
        // åŠ è½½ä¿å­˜çš„å‚æ•°
        loadSavedParams();
        
        // åˆå§‹åŒ–å‚æ•°è¾“å…¥å€¼
        document.getElementById('temperature').value = params.temperature;
        document.getElementById('repeat_penalty').value = params.repeat_penalty;
        document.getElementById('top_p').value = params.top_p;
        document.getElementById('max_tokens').value = params.max_tokens;
        apiBaseUrlInput.value = basePoint;
        
        // åŠ è½½å¯ç”¨æ¨¡å‹
        loadModelTags();
        
        // åŠ è½½ä¿å­˜çš„å¯¹è¯
        loadConversations();
        
        // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
        if (conversations.length === 0) {
            createNewConversation();
        } else {
            // åŠ è½½æœ€è¿‘çš„å¯¹è¯
            setActiveConversation(conversations[0].id);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        setupEventListeners();
        
        // æ›´æ–°æ¬¢è¿åŒºåŸŸçš„å¯è§æ€§
        updateWelcomeVisibility();
    }

    function setupEventListeners() {
        // æ¶ˆæ¯è¾“å…¥äº‹ä»¶
        messageInput.addEventListener('input', () => {
            submitButton.disabled = messageInput.value.trim() === '';
        });
        
        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey && messageInput.value.trim() !== '') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        submitButton.addEventListener('click', sendMessage);
        cleanButton.addEventListener('click', clearChat);
        document.getElementById('save-params').addEventListener('click', saveParams);
        document.getElementById('export-chat').addEventListener('click', exportChat);
        document.getElementById('rollback').addEventListener('click', undoLastMessage);
        
        // æ·±åº¦æ€è€ƒå¼€å…³
deepThinkingToggle.addEventListener('click', () => {
    // å¾ªç¯åˆ‡æ¢çŠ¶æ€ï¼š0 -> 1 -> 2 -> 0
    deepThinkingLevel = (deepThinkingLevel + 1) % 3;
    
    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    deepThinkingToggle.classList.remove('active', 'active-high');
    
    // æ ¹æ®å½“å‰çŠ¶æ€æ·»åŠ å¯¹åº”çš„ç±»
    if (deepThinkingLevel === 1) {
        deepThinkingToggle.classList.add('active');
        deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šä½
        `;
    } else if (deepThinkingLevel === 2) {
        deepThinkingToggle.classList.add('active-high');
        deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šé«˜
        `;
    } else {
        // æ¢å¤åŸå§‹æŒ‰é’®æ–‡æœ¬
        deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒ
        `;
    }
    
    // å­˜å‚¨å½“å‰çŠ¶æ€åˆ°localStorage
    localStorage.setItem('deepThinkingLevel', deepThinkingLevel.toString());
});
        
        // è®¾ç½®é¢æ¿äº‹ä»¶
        paramToggleButton.addEventListener('click', showParamWindow);
        paramClose.addEventListener('click', hideParamWindow);
        paramBackdrop.addEventListener('click', hideParamWindow);
        
        // æ¨¡å‹é€‰æ‹©äº‹ä»¶
// åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
modelDropdown.addEventListener('click', function(e) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡
    e.stopPropagation();
    dropdownMenu.classList.toggle('show');
});

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
document.addEventListener('click', function() {
    dropdownMenu.classList.remove('show');
});

// é˜²æ­¢ç‚¹å‡»ä¸‹æ‹‰èœå•å†…éƒ¨å…ƒç´ å†’æ³¡åˆ°document
dropdownMenu.addEventListener('click', function(e) {
    e.stopPropagation();
});
        
        // æ–°ä¼šè¯æŒ‰é’®
        newChatBtn.addEventListener('click', createNewConversation);
        
        // ç¤ºä¾‹é¡¹ç‚¹å‡»äº‹ä»¶
        exampleItems.forEach(item => {
            item.addEventListener('click', () => {
                const exampleText = item.getAttribute('data-example');
                messageInput.value = exampleText;
                submitButton.disabled = false;
                messageInput.focus();
            });
        });
    }

function loadSavedParams() {
    const savedParams = localStorage.getItem('chatParams');
    if (savedParams) {
        try {
            const parsed = JSON.parse(savedParams);
            params = {...defaultParams, ...parsed};
            // åŠ è½½APIåœ°å€
            if (parsed.basePoint) {
                basePoint = parsed.basePoint;
            }
        } catch(e) {
            console.error('åŠ è½½å‚æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        }
    }
    
    // åŠ è½½æ·±åº¦æ€è€ƒçŠ¶æ€
    const savedLevel = localStorage.getItem('deepThinkingLevel');
    deepThinkingLevel = savedLevel ? parseInt(savedLevel) : 0;
    
    // æ ¹æ®ä¿å­˜çš„çŠ¶æ€è®¾ç½®æŒ‰é’®æ ·å¼
    if (deepThinkingLevel === 1) {
        deepThinkingToggle.classList.add('active');
        deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šä½
        `;
    } else if (deepThinkingLevel === 2) {
        deepThinkingToggle.classList.add('active-high');
        deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šé«˜
        `;
    }
}
// é€‰æ‹©æ¨¡å‹
function selectModel(value, text) {
    chatModel = value;
    dropdownSelected.textContent = text;
    // æ›´æ–°é€‰ä¸­çŠ¶æ€æ ·å¼
    const items = dropdownMenu.querySelectorAll('.dropdown-item');
    items.forEach(item => {
        if (item.dataset.value === value) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    // å…³é—­ä¸‹æ‹‰èœå•
    dropdownMenu.classList.remove('show');
    saveCurrentConversation();
}
function loadModelTags() {
    fetch(`${basePoint}/api/tags`)
        .then(res => res.json())
        .then(res => {
            if (res.models && res.models.length) {
                // æ¸…ç©ºä¸‹æ‹‰èœå•
                dropdownMenu.innerHTML = '';
                
                // æ·»åŠ é€‰é¡¹
                res.models.forEach(m => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-item';
                    option.textContent = m.name;
                    option.dataset.value = m.model;
                    
                    // ç‚¹å‡»é€‰é¡¹äº‹ä»¶
                    option.addEventListener('click', function() {
                        selectModel(m.model, m.name);
                    });
                    
                    dropdownMenu.appendChild(option);
                });
                
                // è®¾ç½®é»˜è®¤æ¨¡å‹
                if (res.models.length > 0) {
                    chatModel = res.models[0].model;
                    dropdownSelected.textContent = res.models[0].name;
                    
                    // å¦‚æœéœ€è¦ï¼Œæ›´æ–°æ´»åŠ¨å¯¹è¯æ¨¡å‹
                    if (activeConversationId) {
                        const activeConv = conversations.find(c => c.id === activeConversationId);
                        if (activeConv && activeConv.model) {
                            chatModel = activeConv.model;
                            // æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹åç§°
                            const modelObj = res.models.find(m => m.model === activeConv.model);
                            if (modelObj) {
                                dropdownSelected.textContent = modelObj.name;
                            }
                            
                            // æ›´æ–°é€‰ä¸­é¡¹çš„æ ·å¼
                            const items = dropdownMenu.querySelectorAll('.dropdown-item');
                            items.forEach(item => {
                                if (item.dataset.value === activeConv.model) {
                                    item.classList.add('selected');
                                }
                            });
                        }
                    }
                }
            }
        })
        .catch(err => console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', err));
}

    function loadConversations() {
        const savedConversations = localStorage.getItem('conversations');
        if (savedConversations) {
            try {
                conversations = JSON.parse(savedConversations);
                renderConversationsList();
            } catch(e) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', e);
                conversations = [];
            }
        }
    }

function renderConversationsList() {
    conversationsList.innerHTML = '';
    conversations.forEach(conv => {
        const convItem = document.createElement('div');
        convItem.className = 'conversation-item';
        convItem.dataset.id = conv.id;
        if (conv.id === activeConversationId) {
            convItem.classList.add('active');
        }
        
const titleSpan = document.createElement('span');
titleSpan.className = 'conversation-title';
const title = conv.title || 'æ–°å¯¹è¯';
// é™åˆ¶æ ‡é¢˜é•¿åº¦ä¸º10ä¸ªå­—
const truncatedTitle = title.length > 10 ? title.substring(0, 10) + '...' : title;
titleSpan.textContent = truncatedTitle;
        
        // Create delete button
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-conversation-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.title = 'åˆ é™¤æ­¤å¯¹è¯';
        
        // Add the conversation item click handler to the entire item
        convItem.addEventListener('click', (e) => {
            // Only handle click if it's not on the delete button
            if (!e.target.classList.contains('delete-conversation-btn')) {
                setActiveConversation(conv.id);
            }
        });
        
        // Add event listener to delete button (with stopPropagation)
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent triggering the conversation click
            deleteConversation(conv.id);
        });
        
        convItem.appendChild(titleSpan);
        convItem.appendChild(deleteBtn);
        conversationsList.appendChild(convItem);
    });
}
function deleteConversation(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        // Remove the conversation from the array
        conversations = conversations.filter(conv => conv.id !== id);
        
        // Save to localStorage
        localStorage.setItem('conversations', JSON.stringify(conversations));
        
        // If the deleted conversation was active, set a new active conversation
        if (id === activeConversationId) {
            if (conversations.length > 0) {
                setActiveConversation(conversations[0].id);
            } else {
                // No conversations left, create a new one
                createNewConversation();
            }
        } else {
            // Just update the UI
            renderConversationsList();
        }
    }
}
function createNewConversation() {
    // å¦‚æœå­˜åœ¨ï¼Œå…ˆä¿å­˜å½“å‰å¯¹è¯
    if (activeConversationId) {
        saveCurrentConversation();
    }
    
    // åˆ›å»ºæ–°å¯¹è¯
    const newConv = {
        id: Date.now().toString(),
        title: 'æ–°å¯¹è¯',
        created: new Date().toISOString(),
        messages: [], // ç©ºæ¶ˆæ¯æ•°ç»„
        systemPrompt: document.getElementById('system-prompt').value,
        model: chatModel
    };
    
    // æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    conversations.unshift(newConv);
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('conversations', JSON.stringify(conversations));
    
    // è®¾ç½®ä¸ºæ´»åŠ¨å¯¹è¯
    activeConversationId = newConv.id;
    
    // æ¸…é™¤èŠå¤©å†å²
    chatHistory = [];
    
    // æ›´æ–°UI
    renderConversationsList();
    chatContainer.innerHTML = ''; // æ˜ç¡®æ¸…é™¤èŠå¤©å®¹å™¨
    
    // æ˜ç¡®è®¾ç½®æ¬¢è¿é¡µé¢å¯è§
    welcomeContainer.style.display = 'flex';
}

function setActiveConversation(id) {
    // å¦‚æœç›¸åŒçš„å¯¹è¯å·²ç»æ˜¯æ´»åŠ¨çš„ï¼Œä¸åšä»»ä½•äº‹
    if (id === activeConversationId) return;
    // å¦‚æœæœ‰å½“å‰æ´»åŠ¨å¯¹è¯ï¼Œå…ˆä¿å­˜å®ƒ
    if (activeConversationId) {
        saveCurrentConversation();
    }
    activeConversationId = id;
    const conversation = conversations.find(c => c.id === id);
    if (conversation) {
        // åŠ è½½å¯¹è¯æ•°æ®
        chatHistory = [...(conversation.messages || [])];
        document.getElementById('system-prompt').value = conversation.systemPrompt || '';
        
        // å¦‚æœæœ‰æ¨¡å‹åˆ™è®¾ç½®
        if (conversation.model) {
            chatModel = conversation.model;
            // æ‰¾åˆ°å¹¶æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤º
            fetch(`${basePoint}/api/tags`)
                .then(res => res.json())
                .then(res => {
                    if (res.models && res.models.length) {
                        const modelObj = res.models.find(m => m.model === conversation.model);
                        if (modelObj) {
                            dropdownSelected.textContent = modelObj.name;
                        }
                        
                        // æ›´æ–°é€‰ä¸­é¡¹æ ·å¼
                        const items = dropdownMenu.querySelectorAll('.dropdown-item');
                        items.forEach(item => {
                            item.classList.remove('selected');
                            if (item.dataset.value === conversation.model) {
                                item.classList.add('selected');
                            }
                        });
                    }
                });
        }
        
        // æ¸…é™¤å½“å‰èŠå¤©æ˜¾ç¤º
        chatContainer.innerHTML = '';
        // åªæœ‰åœ¨æœ‰æ¶ˆæ¯çš„æƒ…å†µä¸‹æ‰æ¸²æŸ“å†å²
        if (chatHistory.length > 0) {
            renderChatHistory();
        }
        // æ›´æ–°ä¾§è¾¹æ 
        renderConversationsList();
        // æ›´æ–°æ¬¢è¿åŒºåŸŸå¯è§æ€§ - åœ¨æ¸²æŸ“èŠå¤©åè°ƒç”¨
        updateWelcomeVisibility();
    }
}


    function saveCurrentConversation() {
        if (!activeConversationId) return;
        
        const index = conversations.findIndex(c => c.id === activeConversationId);
        if (index === -1) return;
        
        // æ›´æ–°å¯¹è¯æ•°æ®
        conversations[index].messages = [...chatHistory];
        conversations[index].systemPrompt = document.getElementById('system-prompt').value;
        conversations[index].model = chatModel;
        
        // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œæ›´æ–°æ ‡é¢˜
        if (chatHistory.length > 0 && chatHistory[0].role === 'user') {
            // ä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜ï¼ˆæˆªæ–­ï¼‰
            let title = chatHistory[0].content.trim();
            title = title.split('\n')[0]; // åªå–ç¬¬ä¸€è¡Œ
            if (title.length > 30) {
                title = title.substring(0, 30) + '...';
            }
            conversations[index].title = title;
        }
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('conversations', JSON.stringify(conversations));
        
        // æ›´æ–°UI
        renderConversationsList();
    }

    function sendMessage() {
        if (replyIng) {
            controller?.abort();
            replyIng = false;
            submitButton.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                </svg>
            `;
            return;
        }
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        controller = new AbortController();
        replyIng = true;
        submitButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²å¹¶æ¸²æŸ“
        chatHistory.push({role: "user", content: message});
        renderChatHistory();
        
        // éšè—æ¬¢è¿ç•Œé¢
        updateWelcomeVisibility();
        
        // æ¸…ç©ºè¾“å…¥
        messageInput.value = '';
        //submitButton.disabled = true;
        
        // ä¿å­˜å¸¦æœ‰æ–°æ¶ˆæ¯çš„å¯¹è¯
        saveCurrentConversation();
        
        // è¯·æ±‚åŠ©æ‰‹å›å¤
        requestAssistantResponse();
    }

    async function requestAssistantResponse() {
        // åˆ›å»ºåŒ…å«ç³»ç»Ÿæç¤ºçš„æ¶ˆæ¯æ•°ç»„
        const systemPrompt = document.getElementById('system-prompt').value;
        
        let messagesWithSystem = [
            { role: "system", content: systemPrompt },
            ...chatHistory.map(msg => ({
                ...msg,
                content: msg.role === 'assistant' ? msg.content.replace(/<think>[\s\S]*?<\/think>/gi, '') : msg.content
            }))
        ];
        
        // å¦‚æœå¯ç”¨äº†æ·±åº¦æ€è€ƒï¼Œæ·»åŠ æŒ‡ä»¤
     // æ ¹æ®æ·±åº¦æ€è€ƒçº§åˆ«æ·»åŠ æŒ‡ä»¤
     if (deepThinkingLevel > 0 && messagesWithSystem.length > 1) {
         const lastUserMsg = messagesWithSystem.findLast(msg => msg.role === 'user');
         if (lastUserMsg) {
             // æ ¹æ®æ·±åº¦æ€è€ƒçº§åˆ«æ·»åŠ ä¸åŒçš„æŒ‡ä»¤
             if (deepThinkingLevel === 1) {
                 lastUserMsg.content += "\n\nä½¿ç”¨<think>æ€è€ƒ900å­—";
             } else if (deepThinkingLevel === 2) {
                 lastUserMsg.content += "\n\nä½¿ç”¨<think>æ€è€ƒ1800å­—";
             }
         }
     }
try {
    const response = await fetch(`${basePoint}/api/chat`, {
        signal: controller.signal,
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            model: chatModel,
            messages: messagesWithSystem,
            max_output_tokens: params.max_tokens,
            temperature: params.temperature,
            top_p: params.top_p,
            repeat_penalty: params.repeat_penalty
        })
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let replyContent = '';
    let partialChunk = '';
    
    // åœ¨èŠå¤©å†å²ä¸­åˆå§‹åŒ–åŠ©æ‰‹æ¶ˆæ¯
    chatHistory.push({role: "assistant", content: "", model: chatModel});
    
    while(true) {
        const {done, value} = await reader.read();
        if(done) break;
        
        // Combine any partial data from previous iteration with current chunk
        let chunk = partialChunk + decoder.decode(value, {stream: true});
        partialChunk = '';
        
        // Process complete JSON objects
        let startIdx = 0;
        let endIdx;
        
        while ((endIdx = chunk.indexOf('}\n', startIdx)) !== -1) {
            try {
                const jsonStr = chunk.substring(startIdx, endIdx + 1);
                const data = JSON.parse(jsonStr);
                
                if (data.message?.content) {
                    replyContent += data.message.content;
                    updateLastMessage(replyContent);
                }
                
                startIdx = endIdx + 2; // Move past the "}\n"
            } catch(e) {
                console.error('è§£æé”™è¯¯:', e, 'at chunk:', chunk.substring(startIdx, endIdx + 1));
                startIdx = endIdx + 2; // Skip this malformed JSON and continue
            }
        }
        
        // Save any incomplete JSON data for next iteration
        if (startIdx < chunk.length) {
            partialChunk = chunk.substring(startIdx);
        }
    }
    
    // Handle any remaining partial chunk if it contains valid JSON
    if (partialChunk) {
        try {
            const data = JSON.parse(partialChunk);
            if (data.message?.content) {
                replyContent += data.message.content;
                updateLastMessage(replyContent);
            }
        } catch(e) {
            console.error('æœ€ç»ˆè§£æé”™è¯¯:', e);
        }
    }
    
    // æ¥æ”¶åˆ°å®Œæ•´å›å¤åä¿å­˜å¯¹è¯
    saveCurrentConversation();
} catch(e) {
    if(e.name !== 'AbortError') console.error('è¯·æ±‚é”™è¯¯:', e);
} finally {
    replyIng = false;
    submitButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
        </svg>
    `;
    submitButton.disabled = messageInput.value.trim() === '';
}

    }

    function updateLastMessage(content) {
        chatHistory[chatHistory.length-1].content = content;
        renderChatHistory(false, chatHistory[chatHistory.length-1]);
    }

    function renderChatHistory(isNew = false, data = null) {
        if(data){
            if(isNew){
                chatHistory.push(data);
            }else{
                chatHistory.splice(chatHistory.length-1, 1, data);
            }
        }
        
        if (chatHistory.length === 0) {
            updateWelcomeVisibility();
            return;
        }
        
        chatContainer.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
        
    chatHistory.forEach(chat => {
        const chatDiv = document.createElement('div');
        chatDiv.className = `chat ${chat.role}`;

        const roleDiv = document.createElement('div');
        roleDiv.className = 'role';
        roleDiv.textContent = chat.role === 'user' ? 'User' : chat.model;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';

        // å¤„ç† <think> æ ‡ç­¾
        let content = chat.content;
        let thinkCount = 0;
        // å¤„ç† <think> å’Œ </think> æ ‡ç­¾
        content = content.replace(/<think>|<\/think>/gi, (match) => {
            if (match.toLowerCase() === '<think>') {
                inThinkBlock = true;
                thinkCount++;
                return `<div class="think-container">
                    <div class="think-toggle">
                    <span>æ€è€ƒè¿‡ç¨‹</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#666" width="12" height="12">
  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15.75l7.5-7.5 7.5 7.5"></path>
</svg>
                    </div>
                    <div class="think-content2" style="display: block;">
                        <pre>`;
            } else if (match.toLowerCase() === '</think>') {
                inThinkBlock = false;


                const result = `</pre>
                    </div>
                </div>`;
                currentThinkContent = '';
                return result;
            }
        });

        // å¯¹é <think> å†…å®¹åº”ç”¨ marked è§£æ
        // content = content.replace(/<div class="think-container">[\s\S]*?<\/div>/gi, match => {
        //     return '___THINK_PLACEHOLDER___' + match;
        // });
        content = marked.parse(content);
        content = content.replace(/___THINK_PLACEHOLDER___([\s\S]*?)<\/div>/gi, match => {
            return match.replace('___THINK_PLACEHOLDER___', '');
        });

        messageDiv.innerHTML = content;

        // chatDiv.appendChild(roleDiv);
        chatDiv.appendChild(messageDiv);
        chatContainer.appendChild(chatDiv);

        // æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½
        chatDiv.querySelectorAll('.think-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const content = toggle.nextElementSibling;
if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15.75l7.5-7.5 7.5 7.5"></path>';
} else {
    content.style.display = 'none';
    toggle.querySelector('svg').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 8.25l7.5 7.5 7.5-7.5"></path>';
}
            });
        });
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }

function updateWelcomeVisibility() {
    // ä¸ä»…æ£€æŸ¥chatHistoryçš„é•¿åº¦ï¼Œè¿˜ç¡®ä¿DOMæ˜¯å¹²å‡€çš„
    if (chatHistory.length === 0) {
        welcomeContainer.style.display = 'flex';
        // ç¡®ä¿èŠå¤©å®¹å™¨æ˜¯ç©ºçš„
        chatContainer.innerHTML = '';
    } else {
        welcomeContainer.style.display = 'none';
    }
}


    function undoLastMessage() {
        if(chatHistory.length === 0) return;
        
        let deleteCount = 0;
        const lastMessage = chatHistory[chatHistory.length - 1];
        
        // æƒ…å†µ1ï¼šæœ€åä¸€æ¡æ¶ˆæ¯æ¥è‡ªåŠ©æ‰‹
        if(lastMessage.role === 'assistant') {
            // ç¡®ä¿ä¹‹å‰æœ‰ç”¨æˆ·æ¶ˆæ¯
            if(chatHistory.length >= 2 && chatHistory[chatHistory.length-2].role === 'user') {
                deleteCount = 2;
            } else {
                deleteCount = 1; // ä¸å¯»å¸¸çš„æƒ…å†µï¼šåªæœ‰åŠ©æ‰‹æ¶ˆæ¯
            }
        }
        // æƒ…å†µ2ï¼šæœ€åä¸€æ¡æ¶ˆæ¯æ¥è‡ªç”¨æˆ·
        else if(lastMessage.role === 'user') {
            deleteCount = 1;
        }
        
        if(deleteCount > 0) {
            chatHistory.splice(-deleteCount, deleteCount);
            renderChatHistory();
            saveCurrentConversation();
            updateWelcomeVisibility();
        }
    }

    function clearChat() {
        chatHistory = [];
        renderChatHistory();
        saveCurrentConversation();
        updateWelcomeVisibility();
    }

    function saveParams() {
        // ä¿å­˜APIåœ°å€
        const newBasePoint = apiBaseUrlInput.value.trim();
        if (newBasePoint && newBasePoint !== basePoint) {
            basePoint = newBasePoint;
            // é‡æ–°åŠ è½½æ¨¡å‹
            loadModelTags();
        }
        
        params = {
            temperature: parseFloat(document.getElementById('temperature').value) || defaultParams.temperature,
            repeat_penalty: parseFloat(document.getElementById('repeat_penalty').value) || defaultParams.repeat_penalty,
            top_p: parseFloat(document.getElementById('top_p').value) || defaultParams.top_p,
            max_tokens: parseInt(document.getElementById('max_tokens').value) || defaultParams.max_tokens,
            basePoint: basePoint
        };
        
        localStorage.setItem('chatParams', JSON.stringify(params));
        
        // å°†ç³»ç»Ÿæç¤ºä¿å­˜åˆ°å½“å‰å¯¹è¯
        saveCurrentConversation();
        
        // æ˜¾ç¤ºç¡®è®¤
        alert('è®¾ç½®ä¿å­˜æˆåŠŸ');
        
        // éšè—è®¾ç½®çª—å£
        hideParamWindow();
    }

    function exportChat() {
        if (chatHistory.length === 0) {
            alert('æ²¡æœ‰æ¶ˆæ¯å¯å¯¼å‡º');
            return;
        }
        
        const content = chatHistory.map(msg => 
            `${msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'} (${new Date().toLocaleString()}):\n` +
            `${msg.content.replace(/<think>.*?<\/think>/gis, '')}\n` +
            'â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•'
        ).join('\n\n');
        
        const blob = new Blob([content], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `èŠå¤©è®°å½•_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function showParamWindow() {
        paramWindow.style.display = 'block';
        paramBackdrop.style.display = 'block';
    }

    function hideParamWindow() {
        paramWindow.style.display = 'none';
        paramBackdrop.style.display = 'none';
    }
});
    </script>
</body>
</html>