<!DOCTYPE html>
<html lang="zh">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Tifa èŠå¤©</title>
		<!-- CSS -->
		<link rel="preconnect" href="https://fonts.proxy.ustclug.org">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.proxy.ustclug.org/css2?family=Noto+Sans+SC&display=swap" rel="stylesheet">
		<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<style>
			/* * {
    font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial,
        'PingFang SC', 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei',
        'Microsoft JhengHei', 'Source Han Sans SC', 'Noto Sans CJK SC',
        'Source Han Sans CN', 'Source Han Sans TC', 'Noto Sans CJK TC',
        'WenQuanYi Micro Hei', SimSun, sans-serif;
    font-weight: bold; 
} */

			:root {
				/* ä¸»é¢˜é¢œè‰²å˜é‡ - æš—è‰²æ¨¡å¼é»˜è®¤å€¼ */
				--bg-primary: #222222;
				--bg-secondary: #151515;
				--bg-tertiary: #262626;
				--bg-input: #333333;
				--bg-code: #161616;
				--bg-hover: #444444;
				--bg-active: #2c536c;
				--bg-active-true: #55aa69;
				--bg-active-high: #6c2c36;

				--text-primary: #ffffff;
				--text-secondary: #e0e0e0;
				--text-tertiary: #cccccc;
				--text-muted: #aaaaaa;
				--text-placeholder: #888888;

				--border-color: #444444;
				--border-light: #353535;
				--border-dark: #666666;

				--button-primary: #238636;
				--button-primary-hover: #2baa43;
				--button-secondary: #444444;
				--button-secondary-hover: #555555;

				--scrollbar-thumb: #555555;
				--scrollbar-thumb-light: #353535;
				--scrollbar-thumb-input: #666666;

				--shadow-color: rgba(0, 0, 0, 0.5);
				--overlay-color: rgba(0, 0, 0, 0.5);

				--gradient-top: linear-gradient(180deg, var(--bg-primary) 55%, rgba(34, 34, 34, 0) 100%);
				--gradient-bottom: linear-gradient(0deg, var(--bg-primary) 85%, rgba(34, 34, 34, 0) 100%);
			}

			/* æ˜äº®æ¨¡å¼é¢œè‰² */
			:root.light-mode {
				--bg-primary: #f5f5f5;
				--bg-secondary: #e8e8e8;
				--bg-tertiary: #f0f0f0;
				--bg-input: #ffffff;
				--bg-code: #f8f8f8;
				--bg-hover: #e0e0e0;
				--bg-active: #d0e8ff;
				--bg-active-true: #82ce87;
				--bg-active-high: #ffd0d6;

				--text-primary: #333333;
				--text-secondary: #444444;
				--text-tertiary: #555555;
				--text-muted: #666666;
				--text-placeholder: #777777;

				--border-color: #cccccc;
				--border-light: #dddddd;
				--border-dark: #aaaaaa;

				--button-primary: #e9e9e9;
				--button-primary-hover: #ccc;
				--button-secondary: #e0e0e0;
				--button-secondary-hover: #d0d0d0;

				--scrollbar-thumb: #bbbbbb;
				--scrollbar-thumb-light: #cccccc;
				--scrollbar-thumb-input: #aaaaaa;

				--shadow-color: rgba(0, 0, 0, 0.2);
				--overlay-color: rgba(0, 0, 0, 0.3);

				--gradient-top: linear-gradient(180deg, var(--bg-primary) 55%, rgba(245, 245, 245, 0) 100%);
				--gradient-bottom: linear-gradient(0deg, var(--bg-primary) 85%, rgba(245, 245, 245, 0) 100%);
			}

			body {
				margin: 0;
				background-color: var(--bg-primary);
				display: flex;
				color: var(--text-primary);
			}

			/* Sidebar for conversation history */
			.sidebar {
				width: 260px;
				height: 100vh;
				background-color: var(--bg-secondary);
				color: var(--text-primary);
				display: flex;
				flex-direction: column;
			}

			.sidebar.disabled {
				pointer-events: none;
				/* ç¦æ­¢é¼ æ ‡äº‹ä»¶ */
			}

			.sidebar-header {
				padding: 16px 10px;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.conversations-list-title {
				font-size: 14px;
				font-weight: bold;
				color: var(--text-muted);
				margin-top: 10px;
				padding: 6px 16px;
			}

			.new-chat-btn {
				background-color: var(--bg-secondary);
				color: var(--text-primary);
				border: 0px solid var(--border-color);
				border-radius: 10px;
				padding: 10px 15px;
				width: 100%;
				cursor: pointer;
				font-size: 14px;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
			}

			.new-chat-btn:hover {
				background-color: var(--bg-hover);
			}

			.conversations-list {
				flex: 1;
				overflow-y: auto;
				padding: 10px;
			}

			.conversation-item {
				font-size: 14px;
				padding: 10px;
				margin-bottom: 5px;
				border-radius: 10px;
				cursor: pointer;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.conversation-item:hover {
				background-color: var(--bg-hover);
			}

			.conversation-item.active {
				background-color: var(--bg-tertiary);
			}

			/* Main chat area */
			.main-container {
				flex: 1;
				display: flex;
				flex-direction: column;
				height: 100vh;
			}

			/* Top bar with model selector */
			.top-bar {
				padding: 10px 20px;
				display: flex;
				align-items: center;
				background: var(--gradient-top);
				padding-bottom: 30px;
				margin-bottom: -30px;
				z-index: 1;
			}

			.model-selector {
				background-color: var(--bg-input);
				border: 0px;
				color: var(--text-primary);
				padding: 8px;
				border-radius: 5px;
				outline: none;
				width: auto;
				font-size: 18px;
				font-weight: bold;
			}

			#system-prompt {
				background: var(--bg-input);
				border: 1px solid var(--border-color);
				color: var(--text-tertiary);
				width: 100%;
				min-height: 80px;
				resize: vertical;
				margin-top: 6px;
				font-size: 14px;
				border-radius: 5px;
				padding: 5px;
				font-size: 12px;
				width: calc(100% - 10px);
			}

			/* é»˜è®¤å±…ä¸­æ ·å¼ */
			.chat-container {
				flex: 1;
				overflow-y: auto;
				padding: 20px;
				width: 100%;
				box-sizing: border-box;
				position: relative;
				max-width: 1000px;
				margin: 0 auto;
				left: 0;
				/* åˆå§‹ä½ç½® */
				transition: left 0.5s ease;
				/* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
			}

			/* æœ‰ä»£ç å—æ—¶åº”ç”¨çš„å·¦ç§»æ ·å¼ */
			.chat-container.has-code {
				left: -10%;
				/* å‘å·¦ç§»åŠ¨ï¼Œä½†ä¸è¶…è¿‡å®¹å™¨ */
			}

			.chat-container::-webkit-scrollbar {
				width: 6px;
			}

			.chat-container::-webkit-scrollbar-thumb {
				background-color: var(--scrollbar-thumb);
				border-radius: 3px;
			}

			.conversations-list::-webkit-scrollbar {
				width: 6px;
			}

			.conversations-list::-webkit-scrollbar-thumb {
				background-color: var(--scrollbar-thumb-light);
				border-radius: 3px;
			}

			#message-input::-webkit-scrollbar {
				width: 6px;
			}

			#message-input::-webkit-scrollbar-thumb {
				background-color: var(--scrollbar-thumb-input);
				border-radius: 3px;
			}

			textarea::-webkit-scrollbar-thumb {
				background-color: var(--scrollbar-thumb-input);
				border-radius: 3px;
			}

			textarea::-webkit-scrollbar {
				width: 6px;
			}

			/* Welcome message */
			.welcome-container {
				display: none;
				position: relative;
				height: 100%;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				color: var(--text-secondary);
				text-align: center;
				padding: 20px;
			}

			.welcome-title {
				font-size: 2em;
				margin-bottom: 20px;
				font-weight: bold;
			}

			.welcome-subtitle {
				font-size: 1.2em;
				margin-bottom: 30px;
				color: var(--text-tertiary);
			}

			.welcome-examples {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				gap: 15px;
				max-width: 800px;
			}

			/* å½“å±å¹•é«˜åº¦å°äº500åƒç´ æ—¶ï¼Œéšè— div */
			@media (max-height: 830px) {
				.welcome-examples {
					display: none;
				}
			}

			@media (max-width: 799px) {
				.welcome-examples {
					display: none;
				}
			}

			.example-item {
				background-color: var(--bg-input);
				padding: 15px;
				border-radius: 8px;
				max-width: 300px;
				cursor: pointer;
			}

			.example-item:hover {
				background-color: var(--bg-hover);
			}

			.example-title {
				font-weight: bold;
				margin-bottom: 8px;
			}

			.example-text {
				font-size: 13px;
				color: var(--text-tertiary);
			}

			.chat {
				max-width: 80%;
				margin: 15px auto;
				display: flex;
				flex-direction: column;
			}

			.chat.user {
				align-items: flex-end;
			}

			.chat.assistant {
				align-items: flex-start;
			}

			.chat .role {
				font-weight: bold;
				margin-bottom: 5px;
				color: var(--text-secondary);
				font-size: 0.9em;
			}

			.chat .message {
				padding: 12px 16px;
				border-radius: 25px;
				box-sizing: border-box;
				line-height: 1.5;
			}

			.chat.user .message {
				background: var(--bg-input);
				color: var(--text-primary);
			}

			.chat.assistant .message {
				color: var(--text-primary);
			}

			p {
				margin: 8px 0px;
			}

			/* Input area */
			.input-container {
				padding: 15px 20px;
				background: var(--gradient-bottom);
				padding-top: 30px;
				margin-top: -30px;
				z-index: 1;
			}

			.message-form {
				display: flex;
				flex-direction: column;
				max-width: 800px;
				margin: 0 auto;
				border-radius: 20px;
				padding: 5px;
				background-color: var(--bg-input);
			}

			.input-wrapper {
				position: relative;
				height: 64px;
				margin-bottom: 10px;
				border-radius: 10px;
				background-color: var(--bg-input);
				max-height: 30vh;
				/* æœ€å¤§é«˜åº¦ä¸ºå±å¹•çš„äºŒåˆ†ä¹‹ä¸€ */
				overflow-y: auto;
				/* è¶…å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
				padding: 0px;
				margin: 0px;
			}

			.input-wrapper::-webkit-scrollbar {
				width: 6px;
			}

			.input-wrapper::-webkit-scrollbar-thumb {
				background-color: var(--scrollbar-thumb-input);
				border-radius: 3px;
			}

			#message-input {
				width: 100%;
				min-height: 60px;
				padding: 15px 15px 0px 15px;
				font-size: 16px;
				box-sizing: border-box;
				background-color: transparent;
				border: none;
				outline: none;
				color: var(--text-primary);
				resize: none;
				border-radius: 10px;
			}

			.input-buttons {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 0 10px;
			}

			.action-buttons {
				display: flex;
				gap: 10px;
			}

			.pill-button {
				border-radius: 20px;
				padding: 6px 10px;
				background-color: var(--button-secondary);
				color: var(--text-primary);
				border: none;
				font-size: 12px;
				cursor: pointer;
				display: flex;
				align-items: center;
				gap: 5px;
			}

			.pill-button:hover {
				background-color: var(--button-secondary-hover);
			}

			.pill-button.active {
				background-color: var(--bg-active);
			}

			/* æ–°å¢çš„é«˜çº§åˆ«æ ·å¼ */
			.pill-button.active-high {
				background-color: var(--bg-active-high);
				font-weight: bold;
			}

			.send-button {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background-color: var(--button-primary);
				color: var(--text-primary);
				border: none;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				margin-bottom: 8px;
			}

			.send-button:hover {
				background-color: var(--button-primary-hover);
			}

			.send-button:disabled {
				background-color: var(--button-secondary);
				cursor: not-allowed;
			}

			/* Think container styling */
			.think-container {
				margin: 0px 0;
				border-radius: 5px;
				overflow: hidden;
			}

			.think-toggle {
				cursor: pointer;
				display: flex;
				align-items: center;
			}

			.think-icon {
				margin-right: 8px;
			}

			.think-toggle span {
				color: var(--text-muted);
				font-size: 14px;
				font-weight: bold;
			}

			.think-content,
			.think-content2 {
				margin: 10px 0px;
				font-size: 13px;
				border-left: 2px solid var(--border-dark);
			}

			.think-content pre,
			.think-content2 pre {
				margin: 0;
				white-space: pre-wrap;
				font-size: 13px;
				font-weight: 500;
				border-radius: 0px;
				background-color: transparent;
				word-wrap: break-word;
				color: var(--text-tertiary);
				/*    font-family: 'Courier New', Courier, monospace;*/
			}

			/* Parameter panel */
			#param-window {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: var(--bg-tertiary);
				border: 1px solid var(--border-color);
				border-radius: 8px;
				width: 80%;
				max-width: 500px;
				box-shadow: 0 4px 12px var(--shadow-color);
				z-index: 100;
				display: none;
			}

			.param-backdrop {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: var(--overlay-color);
				z-index: 99;
				display: none;
			}

			.param-header {
				padding: 12px 16px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				color: var(--text-primary);
				font-weight: bold;
			}

			.param-close {
				background: none;
				border: none;
				color: var(--text-primary);
				font-size: 18px;
				cursor: pointer;
			}

			.param-content {
				padding: 16px;
				max-height: 70vh;
				overflow-y: auto;
			}

			.param-group {
				margin-bottom: 16px;
			}

			.param-group-title {
				font-size: 14px;
				color: var(--text-secondary);
				margin-bottom: 10px;
				font-weight: bold;
			}

			.param-item {
				margin: 10px 0;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.param-item label {
				color: var(--text-secondary);
				font-size: 0.85em;
				flex-shrink: 0;
			}

			.param-item input,
			.param-item textarea {
				background: var(--bg-input);
				border: 1px solid var(--border-color);
				border-radius: 4px;
				color: var(--text-primary);
				padding: 6px 8px;
			}

			.param-item input {
				width: 100px;
			}

			.param-actions {
				display: flex;
				gap: 10px;
				margin-top: 16px;
			}

			.param-button {
				flex: 1;
				padding: 8px;
				background: var(--button-secondary);
				border: none;
				border-radius: 4px;
				color: var(--text-primary);
				cursor: pointer;
				font-size: 14px;
			}

			.param-button:hover {
				background: var(--button-secondary-hover);
			}

			.utility-buttons {
				display: flex;
				gap: 10px;
				margin-top: 16px;
			}

			.utility-button {
				flex: 1;
				padding: 10px;
				background: var(--bg-input);
				border: 1px solid var(--border-color);
				border-radius: 4px;
				color: var(--text-primary);
				cursor: pointer;
			}

			.utility-button:hover {
				background: var(--bg-tertiary);
			}

			@media (max-width: 768px) {
				.sidebar {
					position: absolute;
					left: -260px;
					transition: left 0.3s ease;
					z-index: 100;
				}

				.sidebar.open {
					left: 0;
				}

				.main-container {
					width: 100%;
				}

				.mobile-sidebar-toggle {
					display: block;
					position: absolute;
					top: 10px;
					left: 10px;
					z-index: 101;
				}
			}

			.delete-conversation-btn {
				visibility: hidden;
				cursor: pointer;
				color: var(--text-placeholder);
				padding: 2px;
				border-radius: 3px;
				width: 20px;
				height: 20px;
				text-align: center;
			}

			.conversation-item:hover .delete-conversation-btn {
				visibility: visible;
			}

			.delete-conversation-btn:hover {
				color: #ff3333;
				background-color: rgba(255, 0, 0, 0.1);
			}

			pre {
				background: var(--bg-code);
				border-radius: 5px;
				padding: 10px;
				color: var(--text-secondary);
				white-space: break-spaces;
			}

			.custom-dropdown {
				position: relative;
				cursor: pointer;
				user-select: none;
				font-size: 18px;
				font-weight: bold;
			}

			.dropdown-selected {
				padding: 8px 12px;
				color: var(--text-muted);
				border-radius: 6px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.dropdown-selected::after {
				content: '';
				position: absolute;
				right: -5px;
				width: 12px;
				height: 12px;
				background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2.5' stroke='%238e8ea0' class='size-3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5'%3E%3C/path%3E%3C/svg%3E");
				background-repeat: no-repeat;
				background-position: center;
				background-size: contain;
			}

			.dropdown-menu {
				position: absolute;
				font-size: 14px;
				padding: 10px;
				left: 0;
				right: 0;
				background-color: var(--bg-input);
				border-radius: 15px;
				max-height: 500px;
				overflow-y: auto;
				z-index: 100;
				display: none;
				/* é»˜è®¤éšè— */
			}

			.dropdown-menu.show {
				display: block;
				min-width: 280px;
			}

			.dropdown-item {
				font-weight: 500;
				padding: 10px 12px;
				color: var(--text-primary);
				border-radius: 10px;
				margin: 5px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				transition: background-color 0.2s;
			}

			.dropdown-item:hover {
				background-color: var(--bg-hover);
				border-radius: 10px;
			}

			.dropdown-item.selected {
				border-radius: 10px;
			}

			#loading-screen {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: #111;
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			}

			.tifa-text {
				font-size: 3rem;
				font-weight: bold;
				color: #222;
				position: relative;
				background: linear-gradient(-90deg,
						#353535 0%,
						#353535 50%,
						#888 50%,
						#353535 65%);
				background-size: 300% auto;
				-webkit-background-clip: text;
				background-clip: text;
				-webkit-text-fill-color: transparent;
				animation: shine 6s linear infinite;
			}

			@keyframes shine {
				100% {
					background-position: -100% center;
				}

				0% {
					background-position: 200% center;
				}
			}

			.teshu {
				margin: 10px;
				background-color: var(--bg-primary);
				padding: 10px;
				color: var(--text-secondary);
				border-radius: 10px;
				border: 1px solid var(--border-dark);
			}

			.message-actions {
				opacity: 0;
				margin-top: -10px;
				text-align: right;
				display: flex;
				justify-content: flex-end;
				gap: 5px;
				transition: opacity 0.3s ease;
				margin-top: -16px;
				margin-bottom: -10px;
			}

			.chat.assistant:hover .message-actions {
				opacity: 1;
			}

			.action-btn {
				background: none;
				border: none;
				color: var(--text-placeholder);
				cursor: pointer;
				font-size: 14px;
				padding: 5px;
				border-radius: 4px;
				transition: all 0.2s ease;
				transform: translateY(5px);
				opacity: 0;
			}

			.chat.assistant:hover .action-btn {
				transform: translateY(0);
				opacity: 1;
			}

			/* Add staggered delay for each button to create a sequential appearance */
			.chat.assistant:hover .action-btn:nth-child(1) {
				transition-delay: 0.05s;
			}

			.chat.assistant:hover .action-btn:nth-child(2) {
				transition-delay: 0.1s;
			}

			.action-btn:hover {
				background-color: rgba(0, 0, 0, 0.05);
				color: var(--text-placeholder);
			}

			/* Keep the rest of your CSS the same */
			.toast-container {
				position: fixed;
				top: 20px;
				right: 20px;
				z-index: 9999;
			}

			.toast {
				background-color: var(--bg-input);
				color: var(--text-primary);
				padding: 12px 20px;
				border-radius: 15px;
				margin-bottom: 10px;
				opacity: 0;
				transform: translateY(-20px);
				transition: opacity 0.3s, transform 0.3s;
			}

			.toast.show {
				opacity: 1;
				transform: translateY(0);
			}

			/* æµ®åŠ¨ä»£ç å®¹å™¨æ ·å¼ */
			.floating-code {
				position: fixed;
				right: 2%;
				top: 100px;
				width: auto;
				max-width: 40%;
				max-height: 90vh;
				background-color: var(--bg-code);
				border-radius: 8px;
				transform: scale(0.85);
				box-shadow: 0 4px 12px var(--shadow-color);
				overflow: auto;
				z-index: 100;
				display: none;
			}

			.floating-code pre {
				margin: 0;
				padding: 16px;
				overflow: auto;
			}

			.floating-code-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 8px 16px;
				background-color: var(--bg-tertiary);
				border-top-left-radius: 8px;
				border-top-right-radius: 8px;
			}

			.floating-code-title {
				color: var(--text-secondary);
				font-size: 14px;
			}

			.floating-code-close {
				background: none;
				border: none;
				color: var(--text-secondary);
				font-size: 18px;
				cursor: pointer;
			}

			/* é”®å€¼å¯¹ä¸“ç”¨æ ·å¼ */
			.key-value-container {
				font-size: 14px;
				padding: 10px;
				background: var(--bg-code);
				border-radius: 4px;
				color: var(--text-secondary);
				margin: 10px;
				padding: 10px;
				border: 1px solid var(--bg-input);
				border-radius: 10px;
				background-color: var(--bg-primary);
			}

			.kv-row {
				display: flex;
				margin: 6px 0;
				line-height: 1.5;
			}

			.kv-key {
				flex: 0 0 120px;
				padding: 0px 10px;
				font-weight: bold;
			}

			.kv-value {
				flex: 1;
				white-space: pre-wrap;
				text-align: end;
				color: var(--text-secondary);
				padding: 0px 10px;
			}

			.arrow {
				color: #e74c3c;
				margin: 0 3px;
				font-weight: bold;
			}

			/* è°ƒæ•´preå…ƒç´ æ ·å¼ä¿æŒå…¼å®¹ */
			.floating-code pre {
				margin: 0;
				padding: 10px;
				background: var(--bg-code);
			}

			.kv-row.vertical-layout {
				display: flex;
				flex-direction: column;
				margin-bottom: 12px;
			}

			.kv-key-title {
				font-size: 12px;
				color: var(--text-muted);
				font-weight: bold;
				padding: 0px;
				margin-bottom: 4px;
			}

			.kv-value-content {
				font-size: 12px;
				margin-left: 12px;
				padding-left: 8px;
				border-left: 2px solid var(--text-secondary);
			}

			.sidebar-toggle {
				position: fixed;
				top: 20px;
				right: 80px;
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background-color: transparent;
				color: var(--text-primary);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				z-index: 1000;
				border: none;
				transition: all 0.3s ease;
			}

			/* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
			.theme-toggle {
				position: fixed;
				top: 20px;
				right: 20px;
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background-color: transparent;
				color: var(--text-primary);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				/* 				box-shadow: 0 2px 10px var(--shadow-color); */
				z-index: 1000;
				border: none;
				transition: all 0.3s ease;
			}

			.theme-toggle:hover {
				transform: scale(1.1);
			}

			.theme-toggle i {
				font-size: 24px;
			}

			.title-logo {
				padding: 0px;
				padding-top: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.title-logo-text {
				font-size: 28px;
				font-weight: bold;
				color: #a3a3a3;
				margin: 0px 5px;
			}






			.model-info {
				flex: 1;
				margin-right: 15px;
			}

			.model-name {
				font-weight: 500;
				display: block;
				font-weight: bold;
				margin-bottom: 3px;
				color: var(--text-secondary);
			}

			.model-desc {
				font-size: 0.8em;
				color: var(--text-muted);
				display: block;
			}

			.checkmark {
				width: 18px;
				height: 18px;
				border-radius: 50%;
				background: #4CAF50;
				display: none;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 12px;
			}

			.dropdown-item.selected .checkmark {
				display: flex;
			}
		</style>
	</head>

	<body>
		<!-- Sidebar for conversation history -->
		<div id="loading-screen">
			<div class="tifa-text">Tifa</div>
		</div>
		<!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->

		<div class="top-controls">
			<button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
				<i class="fas fa-moon" id="themeIcon"></i>
			</button>
			<button class="sidebar-toggle" id="sidebarToggle" title="é«˜çº§æ§åˆ¶">
				<i class="fas fa-sliders-h"></i>
			</button>
		</div>
		<div class="toast-container" id="toast-container"></div>
		<div class="sidebar">

			<div class="sidebar-header">
				<button class="new-chat-btn">
					æ–°å»ºèŠå¤©
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
					</svg>
				</button>
			</div>
			<div class="conversations-list-title">å¯¹è¯å†å²</div>
			<div class="conversations-list" id="conversations-list">
				<!-- Conversation items will be added here dynamically -->
			</div>
		</div>
		<!-- Main chat area -->
		<div class="main-container">
			<!-- Top bar with model selector -->
			<div class="top-bar">
				<div class="custom-dropdown" id="model-dropdown">
					<div class="dropdown-selected">é€‰æ‹©æ¨¡å‹...</div>
					<div class="dropdown-menu">
						<!-- è¿™é‡Œçš„é€‰é¡¹ä¼šç”±JSåŠ¨æ€å¡«å…… -->
					</div>
				</div>
			</div>
			<div class="welcome-container" id="welcome-container">
				<div class="welcome-title">æ¬¢è¿ä½¿ç”¨ Ollama èŠå¤©</div>
				<div class="welcome-subtitle">ä¸€ä¸ªå¼ºå¤§çš„æœ¬åœ°AIèŠå¤©å·¥å…·</div>
				<div class="welcome-examples">
					<div class="example-item" data-example="å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—">
						<div class="example-title">ğŸ’« åˆ›æ„å†™ä½œ</div>
						<div class="example-text">å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—</div>
					</div>
					<div class="example-item" data-example="è§£é‡Šé‡å­åŠ›å­¦çš„åŸºæœ¬åŸç†ï¼Œç”¨ç®€å•çš„è¯­è¨€">
						<div class="example-title">ğŸ“š è§£é‡Šæ¦‚å¿µ</div>
						<div class="example-text">è§£é‡Šé‡å­åŠ›å­¦çš„åŸºæœ¬åŸç†ï¼Œç”¨ç®€å•çš„è¯­è¨€</div>
					</div>
					<div class="example-item" data-example="å¦‚ä½•åˆ¶ä½œä¸€ä¸ªä¼ ç»Ÿçš„æ„å¤§åˆ©ææ‹‰ç±³è‹ï¼Ÿ">
						<div class="example-title">ğŸ³ é£Ÿè°±æŒ‡å¯¼</div>
						<div class="example-text">å¦‚ä½•åˆ¶ä½œä¸€ä¸ªä¼ ç»Ÿçš„æ„å¤§åˆ©ææ‹‰ç±³è‹ï¼Ÿ</div>
					</div>
					<div class="example-item"
						data-example="å¸®æˆ‘åˆ†æä»¥ä¸‹Pythonä»£ç çš„æ•ˆç‡é—®é¢˜:\ndef fibonacci(n):\n    if n <= 1:\n        return n\n    return fibonacci(n-1) + fibonacci(n-2)">
						<div class="example-title">ğŸ’» ä»£ç åˆ†æ</div>
						<div class="example-text">å¸®æˆ‘åˆ†æPythonä»£ç çš„æ•ˆç‡é—®é¢˜</div>
					</div>
					<div class="example-item" data-example="å¸®æˆ‘è§„åˆ’ä¸€ä¸ªä¸‰å¤©ä¸¤å¤œçš„åŒ—äº¬è¡Œç¨‹ï¼ŒåŒ…å«ä¸»è¦æ™¯ç‚¹">
						<div class="example-title">âœˆï¸ æ—…è¡Œè§„åˆ’</div>
						<div class="example-text">åŒ—äº¬ä¸‰æ—¥æ¸¸è¡Œç¨‹è§„åˆ’</div>
					</div>
					<div class="example-item" data-example="åˆ¶å®šä¸€ä¸ªé€‚åˆåˆå­¦è€…çš„ä¸¤å‘¨å±…å®¶å¥èº«è®¡åˆ’">
						<div class="example-title">ğŸ‹ï¸ å¥èº«è®¡åˆ’</div>
						<div class="example-text">æ–°æ‰‹ä¸¤å‘¨å±…å®¶å¥èº«æ–¹æ¡ˆ</div>
					</div>
				</div>
			</div>
			<div class="chat-container" id="chat-container">
				<!-- Welcome message (visible when chat is empty) -->
				<!-- Chat messages will be added here dynamically -->
			</div>
			<!-- Input area -->
			<div class="input-container">
				<div class="message-form">
					<div class="input-wrapper">
						<textarea id="message-input" placeholder="å‘é€æ¶ˆæ¯..."></textarea>
					</div>
					<div class="input-buttons">
						<div class="action-buttons">
							<button id="deep-thinking-toggle" class="pill-button">
								<svg width="12" height="12" viewBox="0 0 24 24" fill="none"
									xmlns="http://www.w3.org/2000/svg">
									<path
										d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z"
										fill="currentColor" />
								</svg>
								æ·±åº¦æ€è€ƒ
							</button>
							<button id="param-toggle-button" class="pill-button">
								<svg width="12" height="12" viewBox="0 0 24 24" fill="none"
									xmlns="http://www.w3.org/2000/svg">
									<path
										d="M12 15.5C14.21 15.5 16 13.71 16 11.5C16 9.29 14.21 7.5 12 7.5C9.79 7.5 8 9.29 8 11.5C8 13.71 9.79 15.5 12 15.5ZM19.43 12.97C19.47 12.65 19.5 12.33 19.5 12C19.5 11.67 19.47 11.34 19.43 11L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.04 4.95 18.95L7.44 17.95C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.67 16.04 18.34 16.56 17.95L19.05 18.95C19.27 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z"
										fill="currentColor" />
								</svg>
								è®¾ç½®
							</button>
						</div>
						<button id="submit" class="send-button" disabled>
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none"
								xmlns="http://www.w3.org/2000/svg">
								<path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor" />
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Backdrop for modal -->
		<div class="param-backdrop" id="param-backdrop"></div>
		<!-- Advanced parameters panel -->
		<div id="param-window">
			<div class="param-header">
				<span>âš™ï¸ é«˜çº§è®¾ç½®</span>
				<button class="param-close" id="param-close">Ã—</button>
			</div>
			<div class="param-content">
				<div class="param-group">
					<div class="param-group-title">ç³»ç»ŸæŒ‡ä»¤</div>
					<textarea id="system-prompt" placeholder="è¾“å…¥ç³»ç»ŸæŒ‡ä»¤...">æ‚¨ç°åœ¨æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”æ¨¡å‹ï¼Œå‡†å¤‡æ¥å—ç”¨æˆ·çš„è§’è‰²è®¾å®šã€‚å°šæœªåŠ è½½ä»»ä½•è§’è‰²ã€‚</textarea>
				</div>
				<div class="param-group">
					<div class="param-group-title">APIè®¾ç½®</div>
					<div class="param-item">
						<label>APIåœ°å€:</label>
						<input type="text" id="api-base-url" placeholder="http://127.0.0.1:11434" style="width: 200px;">
					</div>
				</div>
				<div class="param-group">
					<div class="param-group-title">ç”Ÿæˆå‚æ•°</div>
					<div class="param-item">
						<label>æ¸©åº¦:</label>
						<input type="number" id="temperature" step="0.1" min="0" max="2" placeholder="0.6">
					</div>
					<div class="param-item">
						<label>é‡å¤æƒ©ç½š:</label>
						<input type="number" id="repeat_penalty" step="0.01" min="1" max="3" placeholder="1.06">
					</div>
					<div class="param-item">
						<label>Top P:</label>
						<input type="number" id="top_p" step="0.1" min="0" max="1" placeholder="0.6">
					</div>
					<div class="param-item">
						<label>æœ€å¤§ä»¤ç‰Œæ•°:</label>
						<input type="number" id="max_tokens" min="100" max="8000" placeholder="1000">
					</div>
				</div>

				<div class="param-group">
					<div class="param-group-title">ç•Œé¢è®¾ç½®</div>
					<div class="param-item">
						<label>ä»£ç æµ®åŠ¨æ˜¾ç¤º:</label>
						<input type="checkbox" id="float-code-toggle">
					</div>
				</div>
				<div class="param-actions">
					<button id="save-params" class="param-button">ä¿å­˜è®¾ç½®</button>
				</div>
				<div class="utility-buttons">
					<button id="rollback" class="utility-button">æ’¤é”€æœ€åä¸€æ¡</button>
					<button id="clean" class="utility-button">æ¸…ç©ºèŠå¤©</button>
					<button id="export-chat" class="utility-button">å¯¼å‡ºèŠå¤©</button>
				</div>
			</div>
		</div>
		<!-- åœ¨</body>å‰æ·»åŠ å³ä¾§è¾¹æ  -->
		<div class="sidebar-right">
			<div class="param-group">
				<div class="param-group-title">è§’è‰²æ‰®æ¼”æ§åˆ¶(ä»…æ”¯æŒUltraV2)</div>

				<!-- æ–‡ç¬”é£æ ¼ -->
				<div class="param-item">
					<label>æ–‡ç¬”é£æ ¼</label>
					<div class="style-slider-container">
						<div class="slider-track">
							<div class="slider-progress" id="style-progress"></div>
						</div>
						<input type="range" id="writing-style" min="0" max="3" step="1" value="1" class="styled-slider">
						<div class="style-labels">
							<span>ç²¾å‡†</span>
							<span>æ™ºèƒ½</span>
							<span>æ–‡è‰º</span>
							<span>å‘æ•£</span>
						</div>
					</div>
				</div>

				<!-- è¾“å‡ºå­—æ•° -->
				<div class="param-item">
					<label>é¢„è®¡è¾“å‡º<output id="word-count-value">200</output>å­—ä»¥å†…</label>
					<div class="style-slider-container">
						<div class="slider-track">
							<div class="slider-progress" id="word-progress"></div>
						</div>
						<input type="range" id="word-count" min="100" max="2000" step="100" value="200"
							class="styled-slider">
						<div class="style-labels">
							<span>çŸ­æ–‡</span>
							<span>é•¿æ–‡</span>
						</div>
					</div>
				</div>

				<!-- æ—ç™½å æ¯” -->
				<div class="param-item">
					<label>å›å¤åå¥½</label>
					<div class="style-slider-container">
						<div class="slider-track">
							<div class="slider-progress" id="narration-progress"></div>
						</div>
						<input type="range" id="narration-ratio" min="1" max="5" step="1" value="2"
							class="styled-slider">
						<div class="style-labels">
							<span>æ—ç™½å¤š</span>
							<span>å¯¹è¯å¤š</span>
						</div>
					</div>
				</div>

				<!-- å‰§æƒ…èŠ‚å¥ -->
				<div class="param-item">
					<label>å‰§æƒ…èŠ‚å¥</label>
					<div class="pace-buttons-setting">
						<button class="pill-button pace-option" data-pace="slow">æ…¢</button>
						<button class="pill-button pace-option active" data-pace="medium">ä¸­</button>
						<button class="pill-button pace-option" data-pace="fast">å¿«</button>

					</div>
				</div>

				<!-- çŠ¶æ€æ å¼€å…³ -->
				<div class="param-item switch-item">
					<label>å¼€å¯çŠ¶æ€æ </label>
					<label class="switch">
						<input type="checkbox" id="status-bar-toggle" checked>
						<span class="slider"></span>
					</label>
				</div>
			</div>
		</div>

		<style>
			/* æ–°å¢CSS */

			/* æ–°å¢ CSS æ ·å¼ */
			.style-slider-container,
			.word-count-container,
			.narration-slider {
				position: relative;
			}

			.slider-track {
				position: absolute;
				margin: 6px 6px;
				width: calc(100% - 12px);
				height: 10px;
				background: var(--border-color);
				border-radius: 2px;
				pointer-events: none;
			}

			.slider-progress {
				height: 100%;
				width: 50%;
				/* åˆå§‹å€¼å¯¹åº”é»˜è®¤ä½ç½® */
				background: var(--text-primary);
				/* å¡«å……é¢œè‰² */
				border-radius: 2px;
				transition: width 0.3s ease, background 0.3s ease;
				/* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
			}

			.styled-slider {
				position: relative;
				z-index: 1;
				/* ç¡®ä¿æ»‘åŠ¨æ¡åœ¨é¡¶å±‚ */
				background: transparent !important;
				/* éšè—é»˜è®¤è½¨é“ */
			}






			.sidebar-right {
				position: absolute;
				right: 20px;
				top: 80px;
				width: 260px;
				border-radius: 20px;
				background: var(--bg-tertiary);
				border: 1px solid var(--border-color);
				padding: 1rem;
				z-index: 999;
				opacity: 1;
				/* é»˜è®¤ä¸é€æ˜ */
				transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
				/* è¿‡æ¸¡æ•ˆæœ */
			}

			.sidebar-right.active {
				opacity: 0;
				display: none;
				/* å®Œå…¨é€æ˜ */
			}

			/* æ»‘å—æ ·å¼ */
			.styled-slider {
				width: 100%;
				height: 4px;
				background: var(--border-color);
				border-radius: 2px;
				outline: none;
				-webkit-appearance: none;
			}

			.styled-slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				width: 16px;
				height: 16px;
				background: var(--primary-color);
				border-radius: 50%;
				cursor: pointer;
			}

			.style-labels,
			.ratio-labels {
				display: flex;
				justify-content: space-between;
				/* margin-top: 0.5rem; */
				font-size: 9px;
				transform: scale(0.9);
				color: var(--text-muted);
			}

			.pace-buttons-setting {
				display: flex;
				gap: 0.5rem;
				margin-top: 0.5rem;
				background-color: var(--button-secondary);
				border-radius: 20px;
				padding: 3px;
			}

			.pace-option.active {
				background: var(--bg-tertiary);
			}

			.switch {
				position: relative;
				display: inline-block;
				width: 40px;
				height: 20px;
			}

			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}

			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: var(--border-color);
				transition: .4s;
				border-radius: 20px;
			}

			.slider:before {
				position: absolute;
				content: "";
				height: 16px;
				width: 16px;
				left: 2px;
				bottom: 2px;
				background-color: white;
				transition: .4s;
				border-radius: 50%;
			}

			input:checked+.slider {
				background-color: var(--bg-active-true);
			}

			input:checked+.slider:before {
				transform: translateX(20px);
			}

			.switch-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
		</style>

		<script>
			// æœ¬åœ°å­˜å‚¨é”®å
			const STORAGE_KEY = 'rp_settings';
			const FORMATTED_KEY = 'novelSettings'; // æ–°å¢æ ¼å¼åŒ–å­˜å‚¨é”®

			const rightSidebar = document.querySelector('.sidebar-right');
			const sidebarToggle = document.getElementById('sidebarToggle');

			sidebarToggle.addEventListener('click', () => {
				rightSidebar.classList.toggle('active');
			});

			// åˆå§‹åŒ–è®¾ç½®
			let settings = {
				style: 1,
				wordCount: 200,
				narration: 1,
				pace: 'medium',
				statusBar: true
			};

			// ç»Ÿä¸€æ›´æ–°è¿›åº¦æ¡å‡½æ•°
			function updateSlider(sliderId, progressId) {
				const slider = document.getElementById(sliderId);
				const progress = document.getElementById(progressId);
				const range = slider.max - slider.min;
				const percent = (slider.value - slider.min) / range * 100;
				progress.style.width = percent + '%';
			}

			// ç»‘å®šæ‰€æœ‰æ»‘åŠ¨æ¡äº‹ä»¶
			function initSlider(sliderId, progressId, updateHandler) {
				const slider = document.getElementById(sliderId);

				slider.addEventListener('input', () => {
					updateSlider(sliderId, progressId);
					if (updateHandler) updateHandler(slider.value);
					saveSettings();
				});

				updateSlider(sliderId, progressId);
			}

			// ä¿å­˜è®¾ç½®
			function saveSettings() {
				settings = {
					style: parseInt(document.getElementById('writing-style').value),
					wordCount: parseInt(document.getElementById('word-count').value),
					narration: parseInt(document.getElementById('narration-ratio').value),
					pace: document.querySelector('.pace-option.active').dataset.pace,
					statusBar: document.getElementById('status-bar-toggle').checked
				};

				localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
				updateStatusDisplay(); // æ›´æ–°æ—¶ä¼šè‡ªåŠ¨å­˜å‚¨æ ¼å¼åŒ–å­—ç¬¦ä¸²
			}

			// è¯»å–è®¾ç½®
			function loadSettings() {
				const saved = localStorage.getItem(STORAGE_KEY);
				if (saved) {
					try {
						settings = JSON.parse(saved);
						settings.style = Math.min(Math.max(settings.style, 0), 3);
						settings.wordCount = Math.min(Math.max(settings.wordCount, 100), 2000);
						settings.narration = Math.min(Math.max(settings.narration, 1), 5);

						document.getElementById('writing-style').value = settings.style;
						document.getElementById('word-count').value = settings.wordCount;
						document.getElementById('narration-ratio').value = settings.narration;
						document.getElementById('status-bar-toggle').checked = settings.statusBar;

						document.querySelectorAll('.pace-option').forEach(btn => {
							btn.classList.toggle('active', btn.dataset.pace === settings.pace);
						});

						updateSlider('writing-style', 'style-progress');
						updateSlider('word-count', 'word-progress');
						updateSlider('narration-ratio', 'narration-progress');
						document.getElementById('word-count-value').textContent = settings.wordCount;
					} catch (e) {
						console.error('è§£æå­˜å‚¨æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
					}
				}
				updateStatusDisplay(); // ç¡®ä¿ç”Ÿæˆåˆå§‹æ ¼å¼åŒ–å­—ç¬¦ä¸²
			}

			// ç”Ÿæˆå¹¶å­˜å‚¨æ ¼å¼åŒ–å­—ç¬¦ä¸²
			function updateStatusDisplay() {
				// è®¡ç®—æ®µè½æ•°
				let paragraphSize;
				switch (settings.pace) {
					case 'fast':
						paragraphSize = 90;
						break;
					case 'medium':
						paragraphSize = 140;
						break;
					case 'slow':
						paragraphSize = 250;
						break;
					default:
						paragraphSize = 150;
				}
				const paragraphs = Math.round(settings.wordCount / paragraphSize);

				// å¤„ç†å¯¹è¯å æ¯”ä¸‰æ¡£
				let dialogRatio;
				if (settings.narration <= 2) dialogRatio = 'ä½';
				else if (settings.narration >= 4) dialogRatio = 'é«˜';
				else dialogRatio = 'ä¸­';

				const statusOutput = `{
		é£æ ¼ï¼š${['ä¸¥è°¨ï¼Œå·¥æ•´ï¼Œæ ‡å‡†','æ¸…æ°´æ–‡ï¼Œæ ‡å‡†','å¥½æ–‡ç¬”ï¼Œæ´»æ³¼','æ·±åº¦æ€è€ƒï¼Œå‘ç™«æ–‡å­¦ï¼Œæ–‡è‰º'][settings.style]} 
		å­—æ•°ï¼š${settings.wordCount-100}å­—
		æ®µè½ï¼š${paragraphs}
		å¯¹è¯å æ¯”ï¼š${dialogRatio}
		çŠ¶æ€æ ï¼š${settings.statusBar ? 'å¼€' : 'å…³'}
		}`;

				// å­˜å‚¨æ ¼å¼åŒ–å­—ç¬¦ä¸²
				localStorage.setItem(FORMATTED_KEY, statusOutput);
				console.log(statusOutput);
			}

			// åˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', () => {
				initSlider('writing-style', 'style-progress');
				initSlider('word-count', 'word-progress', (v) => {
					document.getElementById('word-count-value').textContent = v;
				});
				initSlider('narration-ratio', 'narration-progress');

				document.querySelectorAll('.pace-option').forEach(btn => {
					btn.addEventListener('click', function() {
						document.querySelectorAll('.pace-option').forEach(b => b.classList.remove(
							'active'));
						this.classList.add('active');
						saveSettings();
					});
				});

				document.getElementById('status-bar-toggle').addEventListener('change', saveSettings);

				loadSettings();

				// åˆå§‹åŒ–é»˜è®¤å­˜å‚¨
				if (!localStorage.getItem(FORMATTED_KEY)) {
					saveSettings();
				}
			});
		</script>
		<script src="./utils/marked.min.js"></script>
		<script>
			// ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
			document.addEventListener('DOMContentLoaded', function() {
				const themeToggle = document.getElementById('themeToggle');
				const themeIcon = document.getElementById('themeIcon');
				const root = document.documentElement;

				// æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸»é¢˜åå¥½
				const savedTheme = localStorage.getItem('theme');
				if (savedTheme === 'light') {
					root.classList.add('light-mode');
					themeIcon.classList.remove('fa-moon');
					themeIcon.classList.add('fa-sun');
				}

				// åˆ‡æ¢ä¸»é¢˜
				themeToggle.addEventListener('click', function() {
					if (root.classList.contains('light-mode')) {
						// åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼
						root.classList.remove('light-mode');
						themeIcon.classList.remove('fa-sun');
						themeIcon.classList.add('fa-moon');
						localStorage.setItem('theme', 'dark');
					} else {
						// åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼
						root.classList.add('light-mode');
						themeIcon.classList.remove('fa-moon');
						themeIcon.classList.add('fa-sun');
						localStorage.setItem('theme', 'light');
					}

				});

				// æ·»åŠ ç³»ç»Ÿä¸»é¢˜è‡ªåŠ¨é€‚åº”ï¼ˆå¯é€‰ï¼‰
				const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

				function handleThemeChange(e) {
					if (!localStorage.getItem('theme')) { // åªæœ‰ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ä¸»é¢˜æ—¶æ‰è‡ªåŠ¨é€‚åº”
						if (e.matches) {
							root.classList.remove('light-mode');
							themeIcon.classList.remove('fa-sun');
							themeIcon.classList.add('fa-moon');
						} else {
							root.classList.add('light-mode');
							themeIcon.classList.remove('fa-moon');
							themeIcon.classList.add('fa-sun');
						}
					}
				}

				// åˆå§‹æ£€æŸ¥
				if (!savedTheme) {
					handleThemeChange(prefersDarkScheme);
				}

				// ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
				prefersDarkScheme.addEventListener('change', handleThemeChange);
			});


















			window.addEventListener('load', function() {
				var loadingScreen = document.getElementById('loading-screen');
				loadingScreen.style.transition = 'opacity 0.5s';
				loadingScreen.style.opacity = '0';

				setTimeout(function() {
					loadingScreen.style.display = 'none';
				}, 500); // ç­‰å¾…0.5ç§’åéšè—åŠ è½½åŠ¨ç”»
			});


			document.addEventListener('DOMContentLoaded', () => {
				// é»˜è®¤è®¾ç½®
				let basePoint = "http://127.0.0.1:11434";
				let chatModel = "";
				const defaultParams = {
					temperature: 0.6,
					repeat_penalty: 1.06,
					top_p: 0.6,
					max_tokens: 1000
				};
				let params = {
					...defaultParams
				};
				let chatHistory = [];
				let replyIng = false;
				let controller = null;
				let isDeepThinkingEnabled = false;
				let conversations = [];
				let activeConversationId = null;
				let deepThinkingLevel = 0; // 0: å…³é—­, 1: ä½, 2: é«˜
				// DOM å…ƒç´ 
				const chatContainer = document.getElementById('chat-container');
				const welcomeContainer = document.getElementById('welcome-container');
				const submitButton = document.getElementById('submit');
				const messageInput = document.getElementById('message-input');
				const modelDropdown = document.getElementById("model-dropdown");
				const dropdownSelected = modelDropdown.querySelector(".dropdown-selected");
				const dropdownMenu = modelDropdown.querySelector(".dropdown-menu");
				const cleanButton = document.getElementById('clean');
				const deepThinkingToggle = document.getElementById('deep-thinking-toggle');
				const paramToggleButton = document.getElementById('param-toggle-button');
				const paramWindow = document.getElementById('param-window');
				const paramBackdrop = document.getElementById('param-backdrop');
				const paramClose = document.getElementById('param-close');
				const conversationsList = document.getElementById('conversations-list');
				const newChatBtn = document.querySelector('.new-chat-btn');
				const apiBaseUrlInput = document.getElementById('api-base-url');
				const exampleItems = document.querySelectorAll('.example-item');
				const textarea = document.getElementById('message-input');
				// è·å–å…ƒç´ 
				const sidebar = document.querySelector('.sidebar');
				submitButton.disabled = false;



				// ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨æµ®åŠ¨ä»£ç æ¡†çš„ä½ç½®
				let floatingCodePosition = {
					top: null,
					left: null
				};

				textarea.addEventListener('input', function() {
					// é‡ç½®é«˜åº¦ï¼Œä»¥ä¾¿è®¡ç®—æ–°çš„é«˜åº¦
					this.style.height = 'auto';
					// è®¾ç½®æ–°çš„é«˜åº¦
					this.style.height = this.scrollHeight + 'px';

					// è°ƒæ•´çˆ¶å®¹å™¨çš„é«˜åº¦
					const wrapper = this.parentElement;
					wrapper.style.height = this.scrollHeight + 4 + 'px';

					// å‘ä¸Šå»¶ä¼¸
					const deltaHeight = this.scrollHeight - this.clientHeight;
					if (deltaHeight > 0) {
						wrapper.style.bottom = `calc(${wrapper.style.bottom || '0px'} + ${deltaHeight}px)`;
					}
				});



				function resetTextareaHeight() {
					// å°†é«˜åº¦è®¾ç½®ä¸ºautoå¯ä»¥é‡ç½®é«˜åº¦
					textarea.style.height = 'auto';
					// ç”±äºè®¾ç½®äº†'auto'ï¼Œè¿™é‡Œéœ€è¦å†æ¬¡è®¾ç½®ä¸ºscrollHeightæ¥ç¡®ä¿æ˜¾ç¤ºæ‰€æœ‰æ–‡æœ¬
					textarea.style.height = `${textarea.scrollHeight}px`;


					// è°ƒæ•´çˆ¶å®¹å™¨çš„é«˜åº¦
					const wrapper = textarea.parentElement;
					wrapper.style.height = textarea.scrollHeight + 4 + 'px';
				}





				// åˆå§‹åŒ–åº”ç”¨
				initApp();

				function initApp() {
					// åŠ è½½ä¿å­˜çš„å‚æ•°
					loadSavedParams();

					// åˆå§‹åŒ–å‚æ•°è¾“å…¥å€¼
					document.getElementById('temperature').value = params.temperature;
					document.getElementById('repeat_penalty').value = params.repeat_penalty;
					document.getElementById('top_p').value = params.top_p;
					document.getElementById('max_tokens').value = params.max_tokens;
					apiBaseUrlInput.value = basePoint;

					// åŠ è½½å¯ç”¨æ¨¡å‹
					loadModelTags();

					// åŠ è½½ä¿å­˜çš„å¯¹è¯
					loadConversations();

					// å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
					if (conversations.length === 0) {
						createNewConversation();
					} else {
						// åŠ è½½æœ€è¿‘çš„å¯¹è¯
						setActiveConversation(conversations[0].id);
					}

					// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
					setupEventListeners();

					// æ›´æ–°æ¬¢è¿åŒºåŸŸçš„å¯è§æ€§
					updateWelcomeVisibility();
				}

				function setupEventListeners() {
					// æ¶ˆæ¯è¾“å…¥äº‹ä»¶
					messageInput.addEventListener('input', () => {
						// submitButton.disabled = messageInput.value.trim() === '';
					});

					messageInput.addEventListener('keypress', e => {
						if (e.key === 'Enter' && !e.shiftKey && messageInput.value.trim() !== '') {
							e.preventDefault();
							sendMessage();
						}
					});

					// æŒ‰é’®ç‚¹å‡»äº‹ä»¶
					submitButton.addEventListener('click', sendMessage);
					cleanButton.addEventListener('click', clearChat);
					document.getElementById('save-params').addEventListener('click', saveParams);
					document.getElementById('export-chat').addEventListener('click', exportChat);
					document.getElementById('rollback').addEventListener('click', undoLastMessage);

					// æ·±åº¦æ€è€ƒå¼€å…³
					deepThinkingToggle.addEventListener('click', () => {
						// å¾ªç¯åˆ‡æ¢çŠ¶æ€ï¼š0 -> 1 -> 2 -> 0
						deepThinkingLevel = (deepThinkingLevel + 1) % 3;

						// ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
						deepThinkingToggle.classList.remove('active', 'active-high');

						// æ ¹æ®å½“å‰çŠ¶æ€æ·»åŠ å¯¹åº”çš„ç±»
						if (deepThinkingLevel === 1) {
							deepThinkingToggle.classList.add('active');
							deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šä½
        `;
						} else if (deepThinkingLevel === 2) {
							deepThinkingToggle.classList.add('active-high');
							deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šé«˜
        `;
						} else {
							// æ¢å¤åŸå§‹æŒ‰é’®æ–‡æœ¬
							deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒ
        `;
						}

						// å­˜å‚¨å½“å‰çŠ¶æ€åˆ°localStorage
						localStorage.setItem('deepThinkingLevel', deepThinkingLevel.toString());
					});

					// è®¾ç½®é¢æ¿äº‹ä»¶
					paramToggleButton.addEventListener('click', showParamWindow);
					paramClose.addEventListener('click', hideParamWindow);
					paramBackdrop.addEventListener('click', hideParamWindow);

					// æ¨¡å‹é€‰æ‹©äº‹ä»¶
					// åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
					modelDropdown.addEventListener('click', function(e) {
						// é˜»æ­¢äº‹ä»¶å†’æ³¡
						e.stopPropagation();
						dropdownMenu.classList.toggle('show');
					});

					// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
					document.addEventListener('click', function() {
						dropdownMenu.classList.remove('show');
					});

					// é˜²æ­¢ç‚¹å‡»ä¸‹æ‹‰èœå•å†…éƒ¨å…ƒç´ å†’æ³¡åˆ°document
					dropdownMenu.addEventListener('click', function(e) {
						e.stopPropagation();
					});

					// æ–°ä¼šè¯æŒ‰é’®
					newChatBtn.addEventListener('click', createNewConversation);

					// ç¤ºä¾‹é¡¹ç‚¹å‡»äº‹ä»¶
					exampleItems.forEach(item => {
						item.addEventListener('click', () => {
							const exampleText = item.getAttribute('data-example');
							messageInput.value = exampleText;
							submitButton.disabled = false;
							messageInput.focus();
						});
					});
				}

				// é€‰æ‹©æ¨¡å‹
				function selectModel(value, text) {
					chatModel = value;
					dropdownSelected.textContent = text;
					// æ›´æ–°é€‰ä¸­çŠ¶æ€æ ·å¼
					const items = dropdownMenu.querySelectorAll('.dropdown-item');
					items.forEach(item => {
						if (item.dataset.value === value) {
							item.classList.add('selected');
						} else {
							item.classList.remove('selected');
						}
					});
					// å…³é—­ä¸‹æ‹‰èœå•
					dropdownMenu.classList.remove('show');
					saveCurrentConversation();
				}

				function loadModelTags() {
					fetch(`${basePoint}/api/tags`)
						.then(res => res.json())
						.then(res => {
							if (res.models && res.models.length) {
								// æ¸…ç©ºä¸‹æ‹‰èœå•
								dropdownMenu.innerHTML = '';

								// æ·»åŠ é€‰é¡¹
								res.models.forEach(m => {
									const option = document.createElement('div');
									option.className = 'dropdown-item';
									option.textContent = m.name;
									option.dataset.value = m.model;

									// ç‚¹å‡»é€‰é¡¹äº‹ä»¶
									option.addEventListener('click', function() {
										selectModel(m.model, m.name);
									});

									dropdownMenu.appendChild(option);
								});

								// è®¾ç½®é»˜è®¤æ¨¡å‹
								if (res.models.length > 0) {
									chatModel = res.models[0].model;
									dropdownSelected.textContent = res.models[0].name;

									// å¦‚æœéœ€è¦ï¼Œæ›´æ–°æ´»åŠ¨å¯¹è¯æ¨¡å‹
									if (activeConversationId) {
										const activeConv = conversations.find(c => c.id === activeConversationId);
										if (activeConv && activeConv.model) {
											chatModel = activeConv.model;
											// æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹åç§°
											const modelObj = res.models.find(m => m.model === activeConv.model);
											if (modelObj) {
												dropdownSelected.textContent = modelObj.name;
											}

											// æ›´æ–°é€‰ä¸­é¡¹çš„æ ·å¼
											const items = dropdownMenu.querySelectorAll('.dropdown-item');
											items.forEach(item => {
												if (item.dataset.value === activeConv.model) {
													item.classList.add('selected');
												}
											});
										}
									}
								}
							}
						})
						.catch(err => console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', err));
				}

				function loadConversations() {
					const savedConversations = localStorage.getItem('conversations');
					if (savedConversations) {
						try {
							conversations = JSON.parse(savedConversations);
							renderConversationsList();
						} catch (e) {
							console.error('åŠ è½½å¯¹è¯å¤±è´¥:', e);
							conversations = [];
						}
					}
				}

				function renderConversationsList() {
					conversationsList.innerHTML = '';
					conversations.forEach(conv => {
						const convItem = document.createElement('div');
						convItem.className = 'conversation-item';
						convItem.dataset.id = conv.id;
						if (conv.id === activeConversationId) {
							convItem.classList.add('active');
						}

						const titleSpan = document.createElement('span');
						titleSpan.className = 'conversation-title';
						const title = conv.title || 'æ–°å¯¹è¯';
						// é™åˆ¶æ ‡é¢˜é•¿åº¦ä¸º10ä¸ªå­—
						const truncatedTitle = title.length > 10 ? title.substring(0, 10) + '...' : title;
						titleSpan.textContent = truncatedTitle;

						// Create delete button
						const deleteBtn = document.createElement('span');
						deleteBtn.className = 'delete-conversation-btn';
						deleteBtn.innerHTML = 'Ã—';
						deleteBtn.title = 'åˆ é™¤æ­¤å¯¹è¯';

						// Add the conversation item click handler to the entire item
						convItem.addEventListener('click', (e) => {
							// Only handle click if it's not on the delete button
							if (!e.target.classList.contains('delete-conversation-btn')) {
								setActiveConversation(conv.id);
							}
						});

						// Add event listener to delete button (with stopPropagation)
						deleteBtn.addEventListener('click', (e) => {
							e.stopPropagation(); // Prevent triggering the conversation click
							deleteConversation(conv.id);
						});

						convItem.appendChild(titleSpan);
						convItem.appendChild(deleteBtn);
						conversationsList.appendChild(convItem);
					});
				}

				function deleteConversation(id) {
					if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
						// Remove the conversation from the array
						conversations = conversations.filter(conv => conv.id !== id);

						// Save to localStorage
						localStorage.setItem('conversations', JSON.stringify(conversations));

						// If the deleted conversation was active, set a new active conversation
						if (id === activeConversationId) {
							if (conversations.length > 0) {
								setActiveConversation(conversations[0].id);
							} else {
								// No conversations left, create a new one
								createNewConversation();
							}
						} else {
							// Just update the UI
							renderConversationsList();
						}
					}
				}

				function createNewConversation() {
					// å¦‚æœå­˜åœ¨ï¼Œå…ˆä¿å­˜å½“å‰å¯¹è¯
					if (activeConversationId) {
						saveCurrentConversation();
					}

					// åˆ›å»ºæ–°å¯¹è¯
					const newConv = {
						id: Date.now().toString(),
						title: 'æ–°å¯¹è¯',
						created: new Date().toISOString(),
						messages: [], // ç©ºæ¶ˆæ¯æ•°ç»„
						systemPrompt: document.getElementById('system-prompt').value,
						model: chatModel
					};

					// æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
					conversations.unshift(newConv);

					// ä¿å­˜åˆ°localStorage
					localStorage.setItem('conversations', JSON.stringify(conversations));

					// è®¾ç½®ä¸ºæ´»åŠ¨å¯¹è¯
					activeConversationId = newConv.id;

					// æ¸…é™¤èŠå¤©å†å²
					chatHistory = [];

					// æ›´æ–°UI
					renderConversationsList();
					chatContainer.innerHTML = ''; // æ˜ç¡®æ¸…é™¤èŠå¤©å®¹å™¨

					// æ˜ç¡®è®¾ç½®æ¬¢è¿é¡µé¢å¯è§
					welcomeContainer.style.display = 'flex';
				}

				function setActiveConversation(id) {
					// å¦‚æœç›¸åŒçš„å¯¹è¯å·²ç»æ˜¯æ´»åŠ¨çš„ï¼Œä¸åšä»»ä½•äº‹
					if (id === activeConversationId) return;
					// å¦‚æœæœ‰å½“å‰æ´»åŠ¨å¯¹è¯ï¼Œå…ˆä¿å­˜å®ƒ
					if (activeConversationId) {
						saveCurrentConversation();
					}
					activeConversationId = id;
					const conversation = conversations.find(c => c.id === id);
					if (conversation) {
						// åŠ è½½å¯¹è¯æ•°æ®
						chatHistory = [...(conversation.messages || [])];
						document.getElementById('system-prompt').value = conversation.systemPrompt || '';

						// å¦‚æœæœ‰æ¨¡å‹åˆ™è®¾ç½®
						if (conversation.model) {
							chatModel = conversation.model;
							// æ‰¾åˆ°å¹¶æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤º
							fetch(`${basePoint}/api/tags`)
								.then(res => res.json())
								.then(res => {
									if (res.models && res.models.length) {
										const modelObj = res.models.find(m => m.model === conversation.model);
										if (modelObj) {
											dropdownSelected.textContent = modelObj.name;
										}

										// æ›´æ–°é€‰ä¸­é¡¹æ ·å¼
										const items = dropdownMenu.querySelectorAll('.dropdown-item');
										items.forEach(item => {
											item.classList.remove('selected');
											if (item.dataset.value === conversation.model) {
												item.classList.add('selected');
											}
										});
									}
								});
						}

						// æ¸…é™¤å½“å‰èŠå¤©æ˜¾ç¤º
						chatContainer.innerHTML = '';
						// åªæœ‰åœ¨æœ‰æ¶ˆæ¯çš„æƒ…å†µä¸‹æ‰æ¸²æŸ“å†å²
						if (chatHistory.length > 0) {
							renderChatHistory();
						}
						// æ›´æ–°ä¾§è¾¹æ 
						renderConversationsList();
						// æ›´æ–°æ¬¢è¿åŒºåŸŸå¯è§æ€§ - åœ¨æ¸²æŸ“èŠå¤©åè°ƒç”¨
						updateWelcomeVisibility();
					}
				}


				function saveCurrentConversation() {
					if (!activeConversationId) return;

					const index = conversations.findIndex(c => c.id === activeConversationId);
					if (index === -1) return;

					// æ›´æ–°å¯¹è¯æ•°æ®
					conversations[index].messages = [...chatHistory];
					conversations[index].systemPrompt = document.getElementById('system-prompt').value;
					conversations[index].model = chatModel;

					// å¦‚æœæœ‰æ¶ˆæ¯ï¼Œæ›´æ–°æ ‡é¢˜
					if (chatHistory.length > 0 && chatHistory[0].role === 'user') {
						// ä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜ï¼ˆæˆªæ–­ï¼‰
						let title = chatHistory[0].content.trim();
						title = title.split('\n')[0]; // åªå–ç¬¬ä¸€è¡Œ
						if (title.length > 30) {
							title = title.substring(0, 30) + '...';
						}
						conversations[index].title = title;
					}

					// ä¿å­˜åˆ°localStorage
					localStorage.setItem('conversations', JSON.stringify(conversations));

					// æ›´æ–°UI
					renderConversationsList();
				}

				function sendMessage() {
					if (replyIng) {
						controller?.abort();
						replyIng = false;
						// å¦‚æœéœ€è¦å–æ¶ˆç¦ç”¨
						sidebar.classList.remove('disabled');
						submitButton.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                </svg>
            `;
						return;
					}





					const message = messageInput.value.trim();
					if (!message) return;

					controller = new AbortController();
					replyIng = true;
					sidebar.classList.add('disabled');
					submitButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;

					// æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²å¹¶æ¸²æŸ“
					chatHistory.push({
						role: "user",
						content: message
					});
					renderChatHistory();

					// éšè—æ¬¢è¿ç•Œé¢
					updateWelcomeVisibility();

					// æ¸…ç©ºè¾“å…¥
					messageInput.value = '';
					//submitButton.disabled = true;
					resetTextareaHeight();
					// ä¿å­˜å¸¦æœ‰æ–°æ¶ˆæ¯çš„å¯¹è¯
					saveCurrentConversation();

					// è¯·æ±‚åŠ©æ‰‹å›å¤
					requestAssistantResponse();
				}

				async function requestAssistantResponse() {
					// åˆ›å»ºåŒ…å«ç³»ç»Ÿæç¤ºçš„æ¶ˆæ¯æ•°ç»„
					const systemPrompt = document.getElementById('system-prompt').value;

					let messagesWithSystem = [{
							role: "system",
							content: systemPrompt
						},
						...chatHistory.map(msg => ({
							...msg,
							content: msg.role === 'assistant' ? msg.content.replace(
								/<think>[\s\S]*?<\/think>/gi, '').trim() : msg.content.trim()
						}))
					];

					console.log(JSON.stringify(messagesWithSystem, null, 2));
					// å¦‚æœå¯ç”¨äº†æ·±åº¦æ€è€ƒï¼Œæ·»åŠ æŒ‡ä»¤
					// æ ¹æ®æ·±åº¦æ€è€ƒçº§åˆ«æ·»åŠ æŒ‡ä»¤
					if (deepThinkingLevel > 0 && messagesWithSystem.length > 1) {
						const lastUserMsg = messagesWithSystem.findLast(msg => msg.role === 'user');
						if (lastUserMsg) {
							// æ ¹æ®æ·±åº¦æ€è€ƒçº§åˆ«æ·»åŠ ä¸åŒçš„æŒ‡ä»¤
							if (deepThinkingLevel === 1) {
								lastUserMsg.content += "\n\nä½¿ç”¨<think>æ€è€ƒ900å­—";
							} else if (deepThinkingLevel === 2) {
								lastUserMsg.content += "\n\nä½¿ç”¨<think>æ€è€ƒ1800å­—";
							}
						}
					}



					const lastUserMsg = messagesWithSystem.findLast(msg => msg.role === 'user');
					if (lastUserMsg) {
						// ä» localStorage è¯»å–æ ¼å¼åŒ–é…ç½®
						const novelSettings = localStorage.getItem('novelSettings') ||
							`{
					é£æ ¼ï¼šæ¸…æ°´æ–‡ï¼Œæ ‡å‡† 
					å­—æ•°ï¼š500å­—
					æ®µè½ï¼š4
					å¯¹è¯å æ¯”ï¼šä½
					çŠ¶æ€æ ï¼šå…³
					}`;

						// æ·»åŠ é…ç½®åˆ°æ¶ˆæ¯å†…å®¹ï¼ˆä¿ç•™åŸæœ‰å†…å®¹ï¼‰
						lastUserMsg.content += `\n\n${novelSettings}`;

						// å¦‚æœéœ€è¦æ›¿æ¢åŸæœ‰å†…å®¹ï¼š
						// lastUserMsg.content = `åŸå§‹å†…å®¹...\n\nå½“å‰åˆ›ä½œé…ç½®ï¼š\n${novelSettings}`;
					}



					try {
						const response = await fetch(`${basePoint}/api/chat`, {
							signal: controller.signal,
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								model: chatModel,
								messages: messagesWithSystem,
								max_output_tokens: params.max_tokens,
								temperature: params.temperature,
								top_p: params.top_p,
								repeat_penalty: params.repeat_penalty
							})
						});

						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}

						const reader = response.body.getReader();
						const decoder = new TextDecoder("utf-8");
						let replyContent = '';
						let partialChunk = '';

						// åœ¨èŠå¤©å†å²ä¸­åˆå§‹åŒ–åŠ©æ‰‹æ¶ˆæ¯
						chatHistory.push({
							role: "assistant",
							content: "",
							model: chatModel
						});

						while (true) {
							const {
								done,
								value
							} = await reader.read();
							if (done) break;

							// Combine any partial data from previous iteration with current chunk
							let chunk = partialChunk + decoder.decode(value, {
								stream: true
							});
							partialChunk = '';

							// Process complete JSON objects
							let startIdx = 0;
							let endIdx;

							while ((endIdx = chunk.indexOf('}\n', startIdx)) !== -1) {
								try {
									const jsonStr = chunk.substring(startIdx, endIdx + 1);
									const data = JSON.parse(jsonStr);

									if (data.message?.content) {
										replyContent += data.message.content;
										updateLastMessage(replyContent);
									}

									startIdx = endIdx + 2; // Move past the "}\n"
								} catch (e) {
									console.error('è§£æé”™è¯¯:', e, 'at chunk:', chunk.substring(startIdx, endIdx + 1));
									startIdx = endIdx + 2; // Skip this malformed JSON and continue
								}
							}

							// Save any incomplete JSON data for next iteration
							if (startIdx < chunk.length) {
								partialChunk = chunk.substring(startIdx);
							}
						}

						// Handle any remaining partial chunk if it contains valid JSON
						if (partialChunk) {
							try {
								const data = JSON.parse(partialChunk);
								if (data.message?.content) {
									replyContent += data.message.content;
									updateLastMessage(replyContent);
								}
							} catch (e) {
								console.error('æœ€ç»ˆè§£æé”™è¯¯:', e);
							}
						}

						// æ¥æ”¶åˆ°å®Œæ•´å›å¤åä¿å­˜å¯¹è¯
						saveCurrentConversation();
					} catch (e) {
						if (e.name !== 'AbortError') console.error('è¯·æ±‚é”™è¯¯:', e);
					} finally {
						replyIng = false;
						// å¦‚æœéœ€è¦å–æ¶ˆç¦ç”¨
						sidebar.classList.remove('disabled');
						submitButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
        </svg>
    `;
						renderChatHistory();
						// submitButton.disabled = messageInput.value.trim() === '';
					}

				}

				function updateLastMessage(content) {
					chatHistory[chatHistory.length - 1].content = content;
					renderChatHistory(false, chatHistory[chatHistory.length - 1]);
				}

				function renderChatHistory(isNew = false, data = null) {
					let codetrue = false;
					if (data) {
						if (isNew) {
							chatHistory.push(data);
						} else {
							chatHistory.splice(chatHistory.length - 1, 1, data);
						}
					}
					if (chatHistory.length === 0) {
						updateWelcomeVisibility();
						return;
					}

					// ç§»é™¤ç°æœ‰çš„æµ®åŠ¨ä»£ç æ¡†
					const existingFloatingCode = document.querySelector('.floating-code');
					if (existingFloatingCode) {
						existingFloatingCode.remove();
					}

					chatContainer.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
					let lastCodeBlock = null;

					chatHistory.forEach((chat, index) => {
						const chatDiv = document.createElement('div');
						chatDiv.className = `chat ${chat.role}`;
						const roleDiv = document.createElement('div');
						roleDiv.className = 'role';
						roleDiv.textContent = chat.role === 'user' ? 'User' : chat.model;
						const messageDiv = document.createElement('div');
						messageDiv.className = 'message';

						// å¤„ç† <think> æ ‡ç­¾
						let content = chat.content;
						let thinkCount = 0;
						// å¤„ç† <think> å’Œ </think> æ ‡ç­¾
						content = content.replace(/<think>|<\/think>/gi, (match) => {
							if (match.toLowerCase() === '<think>') {
								inThinkBlock = true;
								thinkCount++;
								return `<div class="think-container">
                    <div class="think-toggle">
                    <span>æ€è€ƒè¿‡ç¨‹</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#666" width="12" height="12">
  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15.75l7.5-7.5 7.5 7.5"></path>
</svg>
                    </div>
                    <div class="think-content2" style="display: block;">
                        <pre>`;
							} else if (match.toLowerCase() === '</think>') {
								inThinkBlock = false;
								const result = `</pre>
                    </div>
                </div>`;
								currentThinkContent = '';
								return result;
							}
						});

						// æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ä»£ç æµ®åŠ¨åŠŸèƒ½
						const isFloatCodeEnabled = document.getElementById('float-code-toggle')?.checked ||
							false;
						console.log(isFloatCodeEnabled);



						if (chat.role === 'assistant' && isFloatCodeEnabled) {
							// æ›´ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…æ‰€æœ‰è¢«```åŒ…è£¹çš„å†…å®¹
							const codeBlockRegex = /```([\s\S]*?)```/g;
							const codeBlocks = [];
							let match;

							while ((match = codeBlockRegex.exec(content)) !== null) {
								// å°è¯•ä»ä»£ç å—çš„ç¬¬ä¸€è¡Œæå–è¯­è¨€
								const codeContent = match[1];
								let language = '';
								let code = codeContent;

								// æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦åŒ…å«è¯­è¨€æ ‡è¯†
								const firstLineMatch = codeContent.match(/^(\w+)\n([\s\S]*)$/);
								if (firstLineMatch) {
									language = firstLineMatch[1];
									code = firstLineMatch[2];
								}

								codeBlocks.push({
									fullMatch: match[0],
									code: code.trim(),
									language: language
								});
							}

							// ä¿å­˜æœ€åä¸€ä¸ªä»£ç å—
							if (codeBlocks.length > 0) {
								codetrue = true;
								lastCodeBlock = codeBlocks[codeBlocks.length - 1];

								// ä»å†…å®¹ä¸­ç§»é™¤æ‰€æœ‰ä»£ç å—
								for (const block of codeBlocks) {
									content = content.replace(block.fullMatch, '');
								}
							}




						}


						if (codetrue) {
							const chatContainer = document.getElementById('chat-container');
							chatContainer.classList.add('has-code');
						} else {
							// æ²¡æœ‰å¼€å¯çš„æ—¶å€™
							const chatContainer = document.getElementById('chat-container');
							chatContainer.classList.remove('has-code');
						}


						content = content.replace(/\\/g, "aaa@");
						content = content.replace(/\[\n/g, "bbb@");
						content = content.replace(/\n\[/g, "ccc@");
						content = content.replace(/~/g, "ddd@");
						content = marked.parse(content);

						content = content.replace(/ccc@/g, "\n[");
						content = content.replace(/bbb@/g, "[\n");
						content = content.replace(/aaa@/g, "\\");
						content = content.replace(/ddd@/g, "~");
						content = content.replace(/___THINK_PLACEHOLDER___([\s\S]*?)<\/div>/gi, match => {
							return match.replace('___THINK_PLACEHOLDER___', '');
						});
						messageDiv.innerHTML = content;
						chatDiv.appendChild(messageDiv);

						// æ·»åŠ æ¶ˆæ¯æ“ä½œåŒºåŸŸï¼ˆä»…å¯¹åŠ©æ‰‹æ¶ˆæ¯æ·»åŠ ï¼‰
						if (chat.role === 'assistant' && !replyIng) {
							const actionsDiv = document.createElement('div');
							actionsDiv.className = 'message-actions';
							// åˆ›å»ºå¤åˆ¶æŒ‰é’®
							const copyBtn = document.createElement('button');
							copyBtn.className = 'action-btn copy-btn';
							copyBtn.title = 'å¤åˆ¶å†…å®¹';
							copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
							copyBtn.addEventListener('click', () => {
								copyMessageContent(chat.content);
							});
							// åˆ›å»ºé‡æ–°ç”ŸæˆæŒ‰é’®
							const regenerateBtn = document.createElement('button');
							regenerateBtn.className = 'action-btn regenerate-btn';
							regenerateBtn.title = 'é‡æ–°ç”Ÿæˆ';
							regenerateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
							regenerateBtn.dataset.index = index;
							regenerateBtn.addEventListener('click', () => {
								regenerateMessage(index);
							});

							actionsDiv.appendChild(copyBtn);
							actionsDiv.appendChild(regenerateBtn);
							chatDiv.appendChild(actionsDiv);
						}

						chatContainer.appendChild(chatDiv);

						// æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½
						chatDiv.querySelectorAll('.think-toggle').forEach(toggle => {
							toggle.addEventListener('click', () => {
								const content = toggle.nextElementSibling;
								if (content.style.display === 'none') {
									content.style.display = 'block';
									toggle.querySelector('svg').innerHTML =
										'<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15.75l7.5-7.5 7.5 7.5"></path>';
								} else {
									content.style.display = 'none';
									toggle.querySelector('svg').innerHTML =
										'<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 8.25l7.5 7.5 7.5-7.5"></path>';
								}
							});
						});
					});

					// å¦‚æœå­˜åœ¨æœ€åä¸€ä¸ªä»£ç å—ä¸”å¯ç”¨äº†æµ®åŠ¨ä»£ç ï¼Œåˆ™åˆ›å»ºæµ®åŠ¨ä»£ç æ¡†
					if (lastCodeBlock && document.getElementById('float-code-toggle')?.checked) {
						createFloatingCodeBox(lastCodeBlock);
					}
					try {
						MathJax.typeset();
						console.log("23")
					} catch (e) {

						console.log("213")
					}
					chatContainer.scrollTop = chatContainer.scrollHeight;
				}


				// æ·»åŠ å¯æ‹–åŠ¨åŠŸèƒ½
				function makeElementDraggable(element, handle) {
					let pos1 = 0,
						pos2 = 0,
						pos3 = 0,
						pos4 = 0;

					handle.onmousedown = dragMouseDown;

					function dragMouseDown(e) {
						e = e || window.event;
						e.preventDefault();
						// è·å–é¼ æ ‡ä½ç½®
						pos3 = e.clientX;
						pos4 = e.clientY;
						document.onmouseup = closeDragElement;
						document.onmousemove = elementDrag;
					}

					function elementDrag(e) {
						e = e || window.event;
						e.preventDefault();
						// è®¡ç®—æ–°ä½ç½®
						pos1 = pos3 - e.clientX;
						pos2 = pos4 - e.clientY;
						pos3 = e.clientX;
						pos4 = e.clientY;
						// è®¾ç½®å…ƒç´ æ–°ä½ç½®
						element.style.top = (element.offsetTop - pos2) + "px";
						element.style.left = (element.offsetLeft - pos1) + "px";
						element.style.right = "auto"; // é‡è®¾å³ä¾§å®šä½ï¼Œä»¥ä¾¿è‡ªç”±æ‹–åŠ¨

						// ä¿å­˜å½“å‰ä½ç½®
						floatingCodePosition.top = element.offsetTop - pos2;
						floatingCodePosition.left = element.offsetLeft - pos1;
					}

					function closeDragElement() {
						// åœæ­¢ç§»åŠ¨
						document.onmouseup = null;
						document.onmousemove = null;
					}
				}


				function createFloatingCodeBox(codeBlock) {
					const floatingCodeDiv = document.createElement('div');
					floatingCodeDiv.className = 'floating-code';

					// Apply saved position if available
					if (floatingCodePosition.top !== null && floatingCodePosition.left !== null) {
						floatingCodeDiv.style.top = floatingCodePosition.top + "px";
						floatingCodeDiv.style.left = floatingCodePosition.left + "px";
						floatingCodeDiv.style.right = "auto";
						floatingCodeDiv.style.width = "auto";
					}

					// Create header
					const headerDiv = document.createElement('div');
					headerDiv.className = 'floating-code-header';

					const titleSpan = document.createElement('span');
					titleSpan.className = 'floating-code-title';
					let titleText = codeBlock.language ? `Code (${codeBlock.language})` : 'Code';
					if (isChinesePreferred()) {
						titleText = codeBlock.language ? `ä»£ç  (${codeBlock.language})` : 'ä»£ç ';
					}
					titleSpan.textContent = titleText;
					headerDiv.appendChild(titleSpan);

					const closeButton = document.createElement('button');
					closeButton.className = 'floating-code-close';
					closeButton.textContent = 'Ã—';
					closeButton.addEventListener('click', () => {
						floatingCodeDiv.remove();
					});
					headerDiv.appendChild(closeButton);

					floatingCodeDiv.appendChild(headerDiv);

					// Process content
					if (isKeyValueFormat(codeBlock.code)) {
						const lines = codeBlock.code.split('\n');
						const usedKeys = [];

						// First pass: extract special info and create teshu divs
						for (const line of lines) {
							const [key, value] = splitKeyValue(line);
							if (!key || !value) continue;

							const keyLower = key.toLowerCase();

							// Check if it's a special key
							if (keyLower.includes('åœ°ç‚¹') || keyLower.includes('ä½ç½®') || keyLower.includes('åœ°å€') ||
								keyLower.includes('åœºæ™¯') || keyLower.includes('æ—¶é—´') || keyLower.includes('æ—¥æœŸ') ||
								keyLower.includes('npc') || keyLower.includes('è§’è‰²') || keyLower.includes('äººç‰©') ||
								keyLower.includes('å…³ç³»') ||
								keyLower.includes('æƒ³æ³•') || keyLower.includes('æ€è€ƒ')) {

								// Create teshu div for this key-value pair
								const teshuDiv = document.createElement('div');
								teshuDiv.className = 'teshu';

								const rowDiv = document.createElement('div');
								rowDiv.className = 'kv-row';

								if (isValueTooLong(value)) {
									rowDiv.classList.add('vertical-layout');

									const keyDiv = document.createElement('div');
									keyDiv.className = 'kv-key-title';
									keyDiv.innerHTML = addIconToKey(key) + ':';

									const valueDiv = document.createElement('div');
									valueDiv.className = 'kv-value-content';
									valueDiv.innerHTML = formatValue(value);

									rowDiv.appendChild(keyDiv);
									rowDiv.appendChild(valueDiv);
								} else {
									const keySpan = document.createElement('span');
									keySpan.className = 'kv-key';
									keySpan.innerHTML = addIconToKey(key) + ':';

									const valueSpan = document.createElement('span');
									valueSpan.className = 'kv-value';
									valueSpan.innerHTML = formatValue(value);

									rowDiv.appendChild(keySpan);
									rowDiv.appendChild(valueSpan);
								}

								teshuDiv.appendChild(rowDiv);
								floatingCodeDiv.appendChild(teshuDiv);
								usedKeys.push(keyLower);
							}
						}

						// Create container for remaining key-value pairs
						const kvContainer = document.createElement('div');
						kvContainer.className = 'key-value-container';

						// Second pass: process remaining key-value pairs
						for (const line of lines) {
							const [key, value] = splitKeyValue(line);
							if (!key || !value) continue;

							// Skip if already processed as special info
							if (usedKeys.includes(key.toLowerCase())) continue;

							const rowDiv = document.createElement('div');
							rowDiv.className = 'kv-row';

							if (isValueTooLong(value)) {
								rowDiv.classList.add('vertical-layout');

								const keyDiv = document.createElement('div');
								keyDiv.className = 'kv-key-title';
								keyDiv.textContent = key + ':';

								const valueDiv = document.createElement('div');
								valueDiv.className = 'kv-value-content';
								valueDiv.innerHTML = formatValue(value);

								rowDiv.appendChild(keyDiv);
								rowDiv.appendChild(valueDiv);
							} else {
								const keySpan = document.createElement('span');
								keySpan.className = 'kv-key';
								keySpan.textContent = key + ':';

								const valueSpan = document.createElement('span');
								valueSpan.className = 'kv-value';
								valueSpan.innerHTML = formatValue(value);

								rowDiv.appendChild(keySpan);
								rowDiv.appendChild(valueSpan);
							}

							kvContainer.appendChild(rowDiv);
						}

						floatingCodeDiv.appendChild(kvContainer);
					} else {
						// Original pre element code
						const preElement = document.createElement('pre');
						preElement.className = codeBlock.language ? `language-${codeBlock.language}` : '';
						preElement.textContent = codeBlock.code;
						floatingCodeDiv.appendChild(preElement);
					}

					// Add to page and make draggable
					document.body.appendChild(floatingCodeDiv);
					floatingCodeDiv.style.display = 'block';
					makeElementDraggable(floatingCodeDiv, headerDiv);
				}

				// Add icon based on key name
				function addIconToKey(key) {
					const keyLower = key.toLowerCase();

					if (keyLower.includes('åœ°ç‚¹') || keyLower.includes('ä½ç½®') || keyLower.includes('åœ°å€') ||
						keyLower.includes('åœºæ™¯')) {
						return 'ğŸ§­ ' + key;
					}

					if (keyLower.includes('æ—¶é—´') || keyLower.includes('æ—¥æœŸ')) {
						return 'â±ï¸ ' + key;
					}

					if (keyLower.includes('npc') || keyLower.includes('è§’è‰²') || keyLower.includes('äººç‰©')) {
						return 'ğŸ‘¤ ' + key;
					}

					if (keyLower.includes('å¥½æ„Ÿ') || keyLower.includes('å…³ç³»')) {
						return 'ğŸ’— ' + key;
					}

					if (keyLower.includes('æƒ³æ³•') || keyLower.includes('æ€è€ƒ')) {
						return 'ğŸ’­ ' + key;
					}

					return key;
				}

				// æ£€æµ‹ç”¨æˆ·æ˜¯å¦åå¥½ä¸­æ–‡
				function isChinesePreferred() {
					// æ£€æŸ¥é¡µé¢è¯­è¨€
					const htmlLang = document.documentElement.lang;
					if (htmlLang && (htmlLang.toLowerCase().includes('zh') || htmlLang.toLowerCase().includes('cn'))) {
						return true;
					}

					// æ£€æŸ¥æµè§ˆå™¨è¯­è¨€
					const userLang = navigator.language || navigator.userLanguage;
					if (userLang && (userLang.toLowerCase().includes('zh') || userLang.toLowerCase().includes('cn'))) {
						return true;
					}

					return false; // é»˜è®¤ä¸ºè‹±æ–‡
				}

				// è¾…åŠ©å‡½æ•°
				function isKeyValueFormat(content) {
					return /^[\s\S]*[\u4e00-\u9fa5\w]+:/.test(content);
				}

				function splitKeyValue(line) {
					const sepIndex = line.indexOf(':');
					if (sepIndex === -1) return [null, null];
					return [
						line.substring(0, sepIndex).trim(),
						line.substring(sepIndex + 1).trim()
					];
				}

				function formatValue(value) {
					// å°† â†’ æ›¿æ¢ä¸ºç®­å¤´å›¾æ ‡æˆ–æ ·å¼åŒ–æ˜¾ç¤º
					return value.replace(/â†’/g, '<span class="arrow">â†’</span>');
				}

				// åˆ¤æ–­å€¼æ˜¯å¦å¤ªé•¿éœ€è¦å‚ç›´å¸ƒå±€
				function isValueTooLong(value) {
					// å¯ä»¥æ ¹æ®å­—ç¬¦æ•°é‡åˆ¤æ–­
					if (value.length > 20) return true;

					// æˆ–è€…æ£€æŸ¥æ˜¯å¦åŒ…å«æ¢è¡Œç¬¦
					if (value.includes('\n')) return true;

					// æˆ–è€…æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šçš„åˆ†éš”ç¬¦ï¼Œè¡¨ç¤ºå†…å®¹å¯èƒ½æ˜¯å¤æ‚ç»“æ„
					if (value.includes(',') && value.split(',').length > 2) return true;

					return false;
				}




				// å¤åˆ¶æ¶ˆæ¯å†…å®¹
				function copyMessageContent(content) {
					// ç§»é™¤<think>æ ‡ç­¾å’Œå†…å®¹
					const cleanContent = content.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();

					// ä½¿ç”¨clipboard APIå¤åˆ¶æ–‡æœ¬
					navigator.clipboard.writeText(cleanContent)
						.then(() => {
							showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
						})
						.catch(err => {
							console.error('å¤åˆ¶å¤±è´¥:', err);
							// å¤‡ç”¨æ–¹æ³•
							const textarea = document.createElement('textarea');
							textarea.value = cleanContent;
							document.body.appendChild(textarea);
							textarea.select();
							document.execCommand('copy');
							document.body.removeChild(textarea);
							showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
						});
				}

				// é‡æ–°ç”Ÿæˆæ¶ˆæ¯
				// é‡æ–°ç”Ÿæˆæ¶ˆæ¯
				function regenerateMessage(index) {
					// ç¡®ä¿indexæ˜¯åŠ©æ‰‹æ¶ˆæ¯ä¸”ä¹‹å‰æœ‰ç”¨æˆ·æ¶ˆæ¯
					if (index > 0 && chatHistory[index].role === 'assistant') {
						let userMsgIndex = index - 1;

						// æ‰¾åˆ°å‰ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
						while (userMsgIndex >= 0 && chatHistory[userMsgIndex].role !== 'user') {
							userMsgIndex--;
						}

						if (userMsgIndex >= 0) {
							// ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å®ƒæ¥é‡æ–°ç”Ÿæˆ
							const userMessage = chatHistory[userMsgIndex].content;

							// åˆ é™¤ä»è¯¥åŠ©æ‰‹æ¶ˆæ¯åˆ°ç»“å°¾çš„æ‰€æœ‰æ¶ˆæ¯
							chatHistory = chatHistory.slice(0, index);

							// é‡æ–°æ¸²æŸ“èŠå¤©å†å²
							renderChatHistory();

							// æ˜¾ç¤ºæç¤º
							showToast('æ­£åœ¨é‡æ–°ç”Ÿæˆ...');

							// ä¿å­˜å½“å‰ä¼šè¯
							saveCurrentConversation();

							// æ‰‹åŠ¨è§¦å‘è¯·æ±‚åŠ©æ‰‹å›å¤ - è¿™æ˜¯å…³é”®æ­¥éª¤
							controller = new AbortController();
							replyIng = true;
							sidebar.classList.add('disabled');
							submitButton.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;

							// ç›´æ¥è¯·æ±‚åŠ©æ‰‹å“åº”ï¼Œæ— éœ€ä¿®æ”¹èŠå¤©å†å²
							requestAssistantResponse();
						}
					}
				}

				// æ˜¾ç¤ºæç¤ºæ°”æ³¡
				function showToast(message, duration = 3000) {
					const toastContainer = document.getElementById('toast-container');

					const toast = document.createElement('div');
					toast.className = 'toast';
					toast.textContent = message;

					toastContainer.appendChild(toast);

					// æ˜¾ç¤ºæ·¡å…¥åŠ¨ç”»
					setTimeout(() => {
						toast.classList.add('show');
					}, 10);

					// å®šæ—¶åˆ é™¤
					setTimeout(() => {
						toast.classList.remove('show');
						setTimeout(() => {
							toastContainer.removeChild(toast);
						}, 300);
					}, duration);
				}









				function updateWelcomeVisibility() {
					// ä¸ä»…æ£€æŸ¥chatHistoryçš„é•¿åº¦ï¼Œè¿˜ç¡®ä¿DOMæ˜¯å¹²å‡€çš„
					if (chatHistory.length === 0) {
						welcomeContainer.style.display = 'flex';
						// ç¡®ä¿èŠå¤©å®¹å™¨æ˜¯ç©ºçš„
						chatContainer.innerHTML = '';
					} else {
						welcomeContainer.style.display = 'none';
					}
				}


				function undoLastMessage() {
					if (chatHistory.length === 0) return;

					let deleteCount = 0;
					const lastMessage = chatHistory[chatHistory.length - 1];

					// æƒ…å†µ1ï¼šæœ€åä¸€æ¡æ¶ˆæ¯æ¥è‡ªåŠ©æ‰‹
					if (lastMessage.role === 'assistant') {
						// ç¡®ä¿ä¹‹å‰æœ‰ç”¨æˆ·æ¶ˆæ¯
						if (chatHistory.length >= 2 && chatHistory[chatHistory.length - 2].role === 'user') {
							deleteCount = 2;
						} else {
							deleteCount = 1; // ä¸å¯»å¸¸çš„æƒ…å†µï¼šåªæœ‰åŠ©æ‰‹æ¶ˆæ¯
						}
					}
					// æƒ…å†µ2ï¼šæœ€åä¸€æ¡æ¶ˆæ¯æ¥è‡ªç”¨æˆ·
					else if (lastMessage.role === 'user') {
						deleteCount = 1;
					}

					if (deleteCount > 0) {
						chatHistory.splice(-deleteCount, deleteCount);
						renderChatHistory();
						saveCurrentConversation();
						updateWelcomeVisibility();
					}
				}

				function clearChat() {
					chatHistory = [];
					renderChatHistory();
					saveCurrentConversation();
					updateWelcomeVisibility();
				}

				function saveParams() {
					// ä¿å­˜APIåœ°å€
					const newBasePoint = apiBaseUrlInput.value.trim();
					if (newBasePoint && newBasePoint !== basePoint) {
						basePoint = newBasePoint;
						// é‡æ–°åŠ è½½æ¨¡å‹
						loadModelTags();
					}

					params = {
						temperature: parseFloat(document.getElementById('temperature').value) || defaultParams
							.temperature,
						repeat_penalty: parseFloat(document.getElementById('repeat_penalty').value) || defaultParams
							.repeat_penalty,
						top_p: parseFloat(document.getElementById('top_p').value) || defaultParams.top_p,
						max_tokens: parseInt(document.getElementById('max_tokens').value) || defaultParams
							.max_tokens,
						basePoint: basePoint
					};

					// ä¿å­˜ä»£ç æµ®åŠ¨è®¾ç½®
					const floatCodeEnabled = document.getElementById('float-code-toggle').checked;
					localStorage.setItem('floatCodeEnabled', floatCodeEnabled);

					localStorage.setItem('chatParams', JSON.stringify(params));

					// å°†ç³»ç»Ÿæç¤ºä¿å­˜åˆ°å½“å‰å¯¹è¯
					saveCurrentConversation();

					// æ˜¾ç¤ºç¡®è®¤
					// alert('è®¾ç½®ä¿å­˜æˆåŠŸ');

					// éšè—è®¾ç½®çª—å£
					hideParamWindow();

					// åˆ·æ–°èŠå¤©å†å²ä»¥åº”ç”¨æ–°è®¾ç½®
					renderChatHistory();
				}

				function loadSavedParams() {
					const savedParams = localStorage.getItem('chatParams');
					if (savedParams) {
						try {
							const parsed = JSON.parse(savedParams);
							params = {
								...defaultParams,
								...parsed
							};
							// åŠ è½½APIåœ°å€
							if (parsed.basePoint) {
								basePoint = parsed.basePoint;
							}
						} catch (e) {
							console.error('åŠ è½½å‚æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
						}
					}

					// åŠ è½½æ·±åº¦æ€è€ƒçŠ¶æ€
					const savedLevel = localStorage.getItem('deepThinkingLevel');
					deepThinkingLevel = savedLevel ? parseInt(savedLevel) : 0;

					// æ ¹æ®ä¿å­˜çš„çŠ¶æ€è®¾ç½®æŒ‰é’®æ ·å¼
					if (deepThinkingLevel === 1) {
						deepThinkingToggle.classList.add('active');
						deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šä½
        `;
					} else if (deepThinkingLevel === 2) {
						deepThinkingToggle.classList.add('active-high');
						deepThinkingToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V13H11V7ZM11 15H13V17H11V15Z" fill="currentColor"/>
            </svg>
            æ·±åº¦æ€è€ƒï¼šé«˜
        `;
					}

					// åŠ è½½ä»£ç æµ®åŠ¨è®¾ç½®
					const floatCodeEnabled = localStorage.getItem('floatCodeEnabled');
					if (floatCodeEnabled !== null) {
						document.getElementById('float-code-toggle').checked = floatCodeEnabled === 'true';
					}
				}

				function exportChat() {
					if (chatHistory.length === 0) {
						alert('æ²¡æœ‰æ¶ˆæ¯å¯å¯¼å‡º');
						return;
					}

					const content = chatHistory.map(msg =>
						`${msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'} (${new Date().toLocaleString()}):\n` +
						`${msg.content.replace(/<think>.*?<\/think>/gis, '')}\n` +
						'â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•'
					).join('\n\n');

					const blob = new Blob([content], {
						type: 'text/plain'
					});
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = `èŠå¤©è®°å½•_${new Date().toISOString().slice(0,10)}.txt`;
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				}

				function showParamWindow() {
					paramWindow.style.display = 'block';
					paramBackdrop.style.display = 'block';
				}

				function hideParamWindow() {
					paramWindow.style.display = 'none';
					paramBackdrop.style.display = 'none';
				}
			});
		</script>
	</body>

</html>